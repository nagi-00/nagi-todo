<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>𝐝 : ᴛᴏᴅᴏ</title>
  <link rel="icon" href="./favi.ico" type="image/x-icon" />
  <style>
    @font-face {
      font-family: 'HJSS';
      src: url('./HJSS.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'HJSS', sans-serif;
      background: #f5f5f5;
      box-sizing: border-box;
    }
    *, *::before, *::after {
      box-sizing: inherit;
    }
    .edit-delete-btn {
      font-size: 0.75rem;
      color: #888;
      background: none;
      border: none;
      cursor: pointer;
      margin-left: 0.5rem;
    }
    /* color picker 텍스트 숨기기 */
input[type=color] {
  -webkit-appearance: none;
  appearance: none;
  border: none;
  padding: 0;
  width: 1.5rem;
  height: 1.5rem;
  cursor: pointer;
}
/* WebKit 브라우저 스와치 내부 여백 제거 */
input[type=color]::-webkit-color-swatch-wrapper {
  padding: 0;
}
/* WebKit 스와치 테두리 제거 */
input[type=color]::-webkit-color-swatch {
  border: none;
}
/* 스와치 텍스트(헥스코드) 숨기기 */
input[type=color]::-webkit-color-swatch-text {
  display: none;
}
/* Firefox */
input[type=color]::-moz-color-swatch,
input[type=color]::-moz-color-swatch-wrapper {
  border: none;
}
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React, ReactDOM, Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>

  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script type="text/babel">
    // Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyAa-8IWlzzPflkV6Iqzunha5TCnMXclTns",
      authDomain: "nagi-todo.firebaseapp.com",
      databaseURL: "https://nagi-todo-default-rtdb.firebaseio.com/",
      projectId: "nagi-todo",
      storageBucket: "nagi-todo.firebasestorage.app",
      messagingSenderId: "923414063910",
      appId: "1:923414063910:web:e09c59bc3cc72a19686fe7"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // KST 정확하게 계산 (sv-SE 포맷)
    function getSeoulDate() {
      const seoulStr = new Date().toLocaleString('sv-SE', { timeZone: 'Asia/Seoul' });
      return new Date(seoulStr);
    }

    function App() {
      // 기본 상태
      const [selectedDate, setSelectedDate] = React.useState(getSeoulDate());
      const [showSidebar, setShowSidebar] = React.useState(true);
      const [allTodos, setAllTodos] = React.useState({});
      const [accentColor, setAccentColor] = React.useState('#888888');
      const [dateColors, setDateColors] = React.useState({});
      const [noteText, setNoteText] = React.useState('');
      const [notes, setNotes] = React.useState({});
      const [showNotesList, setShowNotesList] = React.useState(false);
      const [notesEditMode, setNotesEditMode] = React.useState(false);
      const [editMode, setEditMode] = React.useState(false);
      const [draggedItem, setDraggedItem] = React.useState(null);
      const [draggedOverItem, setDraggedOverItem] = React.useState(null);

      // 세 구획 입력 상태
      const [textNec, setTextNec] = React.useState('');
      const [textGro, setTextGro] = React.useState('');
      const [textFree, setTextFree] = React.useState('');

      const bulletStates = ['☐','☑','☒'];
      const categories = ['필연의 시간','성장의 시간','자유의 시간'];
      const dateKey = selectedDate.toISOString().split('T')[0];
      const items = allTodos[dateKey] || [];

      // tasksByCategory 계산
      const tasksByCategory = categories.map(cat =>
        items.map((it, i) =>
          it.type === 'todo' && it.category === cat
            ? { ...it, index: i }
            : null
        ).filter(x => x)
      );

      // Firebase 구독: todos
      React.useEffect(() => {
        const ref = database.ref('todos/' + dateKey);
        const handler = ref.on('value', snap => {
          setAllTodos(prev => ({ ...prev, [dateKey]: snap.val() || [] }));
        });
        return () => ref.off('value', handler);
      }, [dateKey]);

      // Firebase 구독: dateColors
      React.useEffect(() => {
        const ref = database.ref('dateColors');
        const handler = ref.on('value', snap => {
          setDateColors(snap.val() || {});
        });
        return () => ref.off('value', handler);
      }, []);

      // Firebase 구독: notes (오늘)
      React.useEffect(() => {
        setNotesEditMode(false);
        const ref = database.ref('notes/' + dateKey);
        const handler = ref.on('value', snap => {
          setNoteText(snap.val() || '');
        });
        return () => ref.off('value', handler);
      }, [dateKey]);

      // Firebase 구독: all notes
      React.useEffect(() => {
        const ref = database.ref('notes');
        const handler = ref.on('value', snap => {
          setNotes(snap.val() || {});
        });
        return () => ref.off('value', handler);
      }, []);

      // accentColor 로컬 저장
      React.useEffect(() => {
        const saved = localStorage.getItem('accentColor');
        if (saved) setAccentColor(saved);
      }, []);
      React.useEffect(() => {
        localStorage.setItem('accentColor', accentColor);
      }, [accentColor]);

      // 월 이동 & Today (Notes 닫기 포함)
      function handlePrevMonth() {
        setSelectedDate(prev => new Date(prev.getFullYear(), prev.getMonth() - 1, 1));
      }
      function handleNextMonth() {
        setSelectedDate(prev => new Date(prev.getFullYear(), prev.getMonth() + 1, 1));
      }
      function handleToday() {
        setSelectedDate(getSeoulDate());
        setShowNotesList(false);
      }

      // 세 구획별 할 일 추가
      function addTodo(cat, text, setter) {
        if (!text.trim()) return;
        database.ref('todos/' + dateKey)
          .set([...items, { type: 'todo', category: cat, text: text.trim(), state: 0 }]);
        setter('');
      }
      function handleKeyDownNec(e)    { if (e.key==='Enter'&& !e.shiftKey){ e.preventDefault(); addTodo('필연의 시간', textNec, setTextNec); }} 
      function handleKeyDownGro(e)    { if (e.key==='Enter'&& !e.shiftKey){ e.preventDefault(); addTodo('성장의 시간', textGro, setTextGro); }} 
      function handleKeyDownFree(e)   { if (e.key==='Enter'&& !e.shiftKey){ e.preventDefault(); addTodo('자유의 시간', textFree, setTextFree); }}

      // 상태 토글
      function toggleState(i) {
        if (editMode) return;
        const upd = items.map((it, idx) =>
          idx === i && it.type === 'todo'
            ? { ...it, state: (it.state + 1) % bulletStates.length }
            : it
        );
        database.ref('todos/' + dateKey).set(upd);
      }
      // 삭제
      function deleteItem(i) {
        const filt = items.filter((_, idx) => idx !== i);
        database.ref('todos/' + dateKey).set(filt);
      }
      // 편집
      function editItem(i) {
        const it = items[i];
        if (!it) return;
        const nt = prompt('Edit text:', it.text);
        if (nt != null && nt.trim()) {
          const copy = [...items];
          copy[i].text = nt.trim();
          database.ref('todos/' + dateKey).set(copy);
        }
      }

      // Notes 저장
      function handleKeyDownNote(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          database.ref('notes/' + dateKey).set(noteText.trim());
          setNotesEditMode(false);
        }
      }
      function handleCurrentDateColorChange(e) {
        database.ref('dateColors/' + dateKey).set(e.target.value);
      }

      // DnD (이전과 동일)
      function handleDragStart(e,i){ if(!editMode)return; setDraggedItem(i); e.currentTarget.style.opacity='0.4'; }
      function handleDragEnd(e)   { if(!editMode)return; e.currentTarget.style.opacity='1'; setDraggedItem(null); setDraggedOverItem(null); }
      function handleDragOver(e,i){ if(!editMode)return; e.preventDefault(); setDraggedOverItem(i); }
      function handleDrop(e,i){
        if(!editMode)return;
        e.preventDefault();
        const copy = [...items];
        const mv = copy.splice(draggedItem,1)[0];
        copy.splice(i,0,mv);
        database.ref('todos/' + dateKey).set(copy);
        setDraggedItem(null); setDraggedOverItem(null);
      }

      // Export as Image (이전과 동일)
      async function exportAsImage(){
        const container = document.querySelector('.todo-container');
        const canvas = await html2canvas(container, { backgroundColor:'#fff' });
        canvas.toBlob(async blob=>{
          try {
            await navigator.clipboard.write([ new ClipboardItem({ 'image/png': blob }) ]);
            alert('클립보드에 이미지를 복사했어.');
          } catch {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `todo-${dateKey}.png`; a.click();
            URL.revokeObjectURL(url);
            alert('이미지를 다운로드했어.');
          }
        });
      }

      // 달력 계산
      const daysInMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth()+1, 0).getDate();
      const firstDay   = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1).getDay();
      const hasTodos   = d => {
        const k = d.toISOString().split('T')[0];
        return allTodos[k] && allTodos[k].length > 0;
      };

      return (
        <div style={{ display:'flex', minHeight:'100vh' }}>
          {/* 모바일 토글 */}
          <button onClick={()=>setShowSidebar(v=>!v)}
            style={{
              position:'fixed',left:'1rem',top:'1rem',zIndex:10,
              background:'#fff',padding:'0.5rem',borderRadius:'9999px',
              boxShadow:'0 2px 5px rgba(0,0,0,0.1)',cursor:'pointer'
            }}
            className="md:hidden"
          >{showSidebar?'←':'→'}</button>

          {/* 사이드바 */}
          <div style={{
            position:'fixed',left:0,top:0,bottom:0,width:'16rem',
            background:'#fff',boxShadow:'0 2px 5px rgba(0,0,0,0.1)',
            overflow:'auto',
            transform: showSidebar ? 'translateX(0)' : 'translateX(-100%)',
            transition:'transform 0.3s ease-in-out', zIndex:20
          }}>
            <div style={{ padding:'1rem' }}>
              <h2 style={{
                fontWeight:'bold',whiteSpace:'pre-line',textAlign:'center',
                marginBottom:'1rem'
              }}>
                {selectedDate.toLocaleString('en-US',{ year:'numeric'})}{'\n'}
                {selectedDate.toLocaleString('en-US',{ month:'long'})}
              </h2>

              {/* ← Today → */}
              <div style={{
                display:'flex',justifyContent:'center',gap:'0.5rem',margin:'0.5rem 0'
              }}>
                <button onClick={handlePrevMonth}
                  style={{ background:'#fff',border:'none',padding:'0.25rem 0.5rem',cursor:'pointer' }}>←</button>
                <button onClick={handleToday}
                  style={{ background:'#fff',border:'none',padding:'0.25rem 0.5rem',cursor:'pointer' }}>Today</button>
                <button onClick={handleNextMonth}
                  style={{ background:'#fff',border:'none',padding:'0.25rem 0.5rem',cursor:'pointer' }}>→</button>
              </div>

              {/* Notes 토글 */}
              <button onClick={()=>setShowNotesList(v=>!v)}
                style={{
                  width:'100%',padding:'0.5rem',marginBottom:'1rem',
                  background:'#f0f0f0',border:'none',cursor:'pointer'
                }}
              >{showNotesList?'Back':'Notes'}</button>

              {showNotesList
                ? Object.entries(notes).sort((a,b)=>b[0].localeCompare(a[0])).map(([d, txt])=>(
                    <div key={d} style={{
                      background:'#fff',borderRadius:'0.5rem',
                      padding:'0.75rem',marginBottom:'0.5rem',
                      boxShadow:'0 1px 3px rgba(0,0,0,0.1)'
                    }}>
                      <div style={{ fontWeight:'600', marginBottom:'0.25rem' }}>
                        {new Date(d).toLocaleString('en-US',{ weekday:'long', year:'numeric', month:'long', day:'numeric' })}
                      </div>
                      <div style={{
                        fontWeight:'bold',whiteSpace:'pre-wrap',
                        color: dateColors[d] || accentColor
                      }}>{txt}</div>
                      <button className="edit-delete-btn"
                        onClick={()=>database.ref('notes/'+d).remove()}
                      >Delete</button>
                    </div>
                  ))
                : <div style={{
                    display:'grid',gridTemplateColumns:'repeat(7,1fr)',
                    gap:'0.25rem',fontSize:'0.875rem'
                  }}>
                    {['S','M','T','W','T','F','S'].map(d=>(
                      <div key={d} style={{
                        textAlign:'center',fontWeight:'500',color:'#666'
                      }}>{d}</div>
                    ))}
                    {Array(firstDay).fill(null).map((_,i)=><div key={i}/>)}
                    {Array.from({ length: daysInMonth }, (_, i) => {
                      const dateObj = new Date(
                        selectedDate.getFullYear(),
                        selectedDate.getMonth(),
                        i + 1
                      );
                      const dKey = dateObj.toISOString().split('T')[0];
                      const isSel = dKey === dateKey;
                      const circleColor = dateColors[dKey] || accentColor;
                      return (
                        <button key={i}
                          onClick={()=>{
                            setSelectedDate(dateObj);
                            if(window.innerWidth<768) setShowSidebar(false);
                          }}
                          style={{
                            width:'1.8rem',height:'1.8rem',margin:'0 auto',
                            display:'flex',alignItems:'center',justifyContent:'center',
                            border:'none',
                            backgroundColor: isSel?circleColor:'transparent',
                            color: isSel?'#fff':'#000',
                            borderRadius:'9999px',cursor:'pointer',
                            position:'relative'
                          }}
                        >
                          <span>{i+1}</span>
                          {hasTodos(dateObj) && (
                            <span style={{
                              fontSize:'0.75rem',
                              color: isSel?'#fff':circleColor,
                              position:'absolute',bottom:'-0.3rem'
                            }}>•</span>
                          )}
                        </button>
                      );
                    })}
                  </div>
              }
            </div>
          </div>

          {/* 메인 영역 */}
          <div style={{
            flex:1,padding:'1rem',
            marginLeft: showSidebar?'16rem':'0',
            transition:'margin-left 0.3s'
          }}>
            <div className="todo-container" style={{
              maxWidth:'42rem',margin:'0 auto',background:'#fff',
              borderRadius:'0.5rem',boxShadow:'0 2px 5px rgba(0,0,0,0.1)',
              padding:'1.5rem'
            }}>
              <h2 style={{
                fontSize:'1.25rem',fontWeight:'bold',marginBottom:'1rem'
              }}>
                {selectedDate.toLocaleString('en-US',{ weekday:'long', year:'numeric', month:'long', day:'numeric' })}
              </h2>

              {/* Notes 입력부 */}
              <div style={{
                display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'1rem'
              }}>
                {(!notesEditMode && noteText.trim()) ? (
                  <div style={{
                    fontWeight:'bold',whiteSpace:'pre-wrap',
                    color: dateColors[dateKey] || accentColor
                  }}
                  onDoubleClick={()=>setNotesEditMode(true)}
                  onContextMenu={e=>{e.preventDefault();setNotesEditMode(true);}}>
                    {noteText}
                  </div>
                ) : (
                  <textarea
                    value={noteText}
                    onFocus={()=>setNotesEditMode(true)}
                    onChange={e=>setNoteText(e.target.value)}
                    onKeyDown={handleKeyDownNote}
                    placeholder="Notes (Enter 저장, Shift+Enter 줄바꿈)"
                    rows={2}
                    style={{
                      width:'100%',border:'1px solid #ccc',
                      padding:'0.5rem',borderRadius:'0.25rem',
                      resize:'vertical',fontWeight:'bold',
                      color: dateColors[dateKey] || accentColor
                    }}
                  />
                )}
                <input
                  type="color"
                  value={dateColors[dateKey] || accentColor}
                  onChange={handleCurrentDateColorChange}
                  style={{
                    width:'1.5rem',height:'1.5rem',
                    borderRadius:'9999px',cursor:'pointer'
                  }}
                />
              </div>

              {/* 세 구획 입력 */}
              <div style={{
                display:'grid',
                gridTemplateColumns:'repeat(3,1fr)',
                gap:'0.5rem',marginBottom:'1rem'
              }}>
                <div>
                  <div style={{fontWeight:'600',marginBottom:'0.25rem'}}>필연의 시간</div>
                  <textarea
                    value={textNec}
                    onChange={e=>setTextNec(e.target.value)}
                    onKeyDown={handleKeyDownNec}
                    placeholder="필연의 시간 (Enter 저장)"
                    rows={3}
                    style={{
                      border:'1px solid #ccc',padding:'0.5rem',
                      borderRadius:'0.25rem',resize:'vertical'
                    }}
                  />
                </div>
                <div>
                  <div style={{fontWeight:'600',marginBottom:'0.25rem'}}>성장의 시간</div>
                  <textarea
                    value={textGro}
                    onChange={e=>setTextGro(e.target.value)}
                    onKeyDown={handleKeyDownGro}
                    placeholder="성장의 시간 (Enter 저장)"
                    rows={3}
                    style={{
                      border:'1px solid #ccc',padding:'0.5rem',
                      borderRadius:'0.25rem',resize:'vertical'
                    }}
                  />
                </div>
                <div>
                  <div style={{fontWeight:'600',marginBottom:'0.25rem'}}>자유의 시간</div>
                  <textarea
                    value={textFree}
                    onChange={e=>setTextFree(e.target.value)}
                    onKeyDown={handleKeyDownFree}
                    placeholder="자유의 시간 (Enter 저장)"
                    rows={3}
                    style={{
                      border:'1px solid #ccc',padding:'0.5rem',
                      borderRadius:'0.25rem',resize:'vertical'
                    }}
                  />
                </div>
              </div>

              {/* 범주별 그룹 표시 */}
              <div style={{ marginTop:'1rem' }}>
                {categories.map((cat, idx) => (
                  <div key={cat} style={{ marginBottom:'1rem' }}>
                    <div style={{ fontWeight:'600', marginBottom:'0.5rem' }}>{cat}</div>
                    {tasksByCategory[idx].map(item => (
                      <div key={item.index} style={{
                        display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.25rem'
                      }}>
                        <span onClick={()=>toggleState(item.index)}
                          style={{ color:accentColor,cursor:'pointer',fontFamily:'monospace' }}>
                          {bulletStates[item.state]}
                        </span>
                        <span style={{ flex:1,whiteSpace:'pre-wrap' }}>{item.text}</span>
                      </div>
                    ))}
                    {idx < categories.length - 1 && (
                      <hr style={{
                        borderTop:`1px solid ${accentColor}`,
                        margin:'0.75rem 0'
                      }}/>
                    )}
                  </div>
                ))}
              </div>

              {/* Export / Edit */}
              <div style={{ display:'flex',gap:'0.5rem',marginTop:'1rem' }}>
                {items.length > 0 && (
                  <button onClick={exportAsImage} style={{
                    flex:1,padding:'0.5rem',
                    background:accentColor,color:'#fff',
                    border:'none',borderRadius:'0.25rem',
                    cursor:'pointer'
                  }}>Export as Image</button>
                )}
                <button onClick={()=>setEditMode(v=>!v)} style={{
                  flex: items.length>0 ? 'unset' : 1,
                  padding:'0.5rem',fontSize:'0.875rem',
                  background: editMode?'#dddddd':'#f0f0f0',
                  border:'none',borderRadius:'0.25rem',
                  cursor:'pointer'
                }}>{editMode?'Done':'Edit'}</button>
              </div>

            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
