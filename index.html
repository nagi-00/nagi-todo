<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ùêù : ·¥õ·¥è·¥Ö·¥è</title>
  <link rel="icon" href="./favi.ico" type="image/x-icon" />
  <style>
    :root { --today-color: #888888; }
    body { margin: 0; padding: 0; font-family: 'HJSS', sans-serif; background: #f5f5f5; }
    #root { display: flex; min-height: 100vh; }
    .sidebar { width: 16rem; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .sidebar h2 { margin: 1rem 0; text-align: center; line-height: 1.2; }
    .sidebar-controls { display: flex; justify-content: center; gap: 0.5rem; margin: 0.5rem 0; }
    .sidebar-controls button { background: #e0e0e0; border: none; padding: 0.5rem; cursor: pointer; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: 0.25rem; padding: 0 0.5rem; }
    .calendar-grid div, .calendar-grid button { width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; }
    .calendar-grid div { font-weight: bold; }
    .calendar-grid button { border: none; background: transparent; cursor: pointer; }
    .calendar-grid button.selected { background-color: var(--today-color); color: #fff; border-radius: 50%; }
    .calendar-grid button:hover { background: #ddd; border-radius: 50%; }
    .main { flex: 1; padding: 1rem; background: #f5f5f5; }
    .main-container { background: #fff; border-radius: 8px; padding: 1rem; margin: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 40rem; }
    .section { margin-bottom: 1rem; }
    textarea, input[type="text"] { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; }
    button.action { padding: 0.5rem 1rem; border: none; background: var(--today-color); color: #fff; cursor: pointer; border-radius: 4px; }
    button.secondary { background: #e0e0e0; color: #000; }
    hr.divider { border: none; border-top: 2px solid var(--today-color); margin: 0.5rem 0; }
    .todo-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #fafafa; border-radius: 4px; }
    .todo-item.dragging { opacity: 0.5; }
    .todo-item span.bullet { color: var(--today-color); }
    .note-display { padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.875rem; }
    .footer-buttons { display: flex; gap: 0.5rem; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script type="text/babel">
    // ÎåÄÌïúÎØºÍµ≠ ÌëúÏ§ÄÏãú ÏñªÍ∏∞
    const getKST = () => {
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset() * 60000;
      return new Date(utc + 9 * 3600000);
    };

    // Firebase ÏÑ§Ï†ï
    const firebaseConfig = {
      apiKey: "AIzaSyAa-8IWlzzPflkV6Iqzunha5TCnMXclTns",
      authDomain: "nagi-todo.firebaseapp.com",
      databaseURL: "https://nagi-todo-default-rtdb.firebaseio.com/",
      projectId: "nagi-todo",
      storageBucket: "nagi-todo.firebasestorage.app",
      messagingSenderId: "923414063910",
      appId: "1:923414063910:web:e09c59bc3cc72a19686fe7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function App() {
      const [date, setDate] = React.useState(getKST());
      const [todos, setTodos] = React.useState([]);
      const [note, setNote] = React.useState('');
      const [locked, setLocked] = React.useState(false);
      const [allNotes, setAllNotes] = React.useState({});
      const [colors, setColors] = React.useState({});
      const [text, setText] = React.useState('');
      const [cat, setCat] = React.useState('');
      const [editMode, setEditMode] = React.useState(false);

      const dateKey = date.toISOString().split('T')[0];
      const weekdays = ['S','M','T','W','T','F','S'];
      const weekdayColors = ['#C87171','#666','#666','#666','#666','#666','#7192C8'];

      // todos Íµ¨ÎèÖ
      React.useEffect(() => {
        const ref = db.ref(`todos/${dateKey}`);
        ref.on('value', snap => setTodos(snap.val() || []));
        return () => ref.off();
      }, [dateKey]);

      // Ïò§ÎäòÏùò ÌïúÎßàÎîî Íµ¨ÎèÖ
      React.useEffect(() => {
        const ref = db.ref(`notes/${dateKey}`);
        ref.on('value', snap => {
          const v = snap.val() || '';
          setNote(v);
          setLocked(!!v);
        });
        return () => ref.off();
      }, [dateKey]);

      // Ï†ÑÏ≤¥ Notes Íµ¨ÎèÖ (ÏÑúÎ∏åÌéòÏù¥ÏßÄ)
      React.useEffect(() => {
        const ref = db.ref('notes');
        ref.on('value', snap => setAllNotes(snap.val() || {}));
        return () => ref.off();
      }, []);

      // ÎÇ†ÏßúÎ≥Ñ ÏÉâÏÉÅ Íµ¨ÎèÖ
      React.useEffect(() => {
        const ref = db.ref('dateColors');
        ref.on('value', snap => {
          const obj = snap.val() || {};
          setColors(obj);
          document.documentElement.style.setProperty('--today-color', obj[dateKey] || '#888888');
        });
        return () => ref.off();
      }, [dateKey]);

      // ÎÖ∏Ìä∏ Ï†ÄÏû• & Í≥†Ï†ï/Ìï¥Ï†ú
      const saveNote = v => db.ref(`notes/${dateKey}`).set(v);
      const lockNote = () => setLocked(true);
      const unlockNote = () => setLocked(false);

      // Ïª¨Îü¨ Ï†ÄÏû•
      const saveColor = e => db.ref('dateColors').update({ [dateKey]: e.target.value });

      // Ìï† Ïùº CRUD
      const addTodo = () => {
        if (!text.trim()) return;
        db.ref(`todos/${dateKey}`).once('value').then(s => {
          const a = s.val() || [];
          a.push({ type: 'todo', text: text.trim(), state: 0 });
          db.ref(`todos/${dateKey}`).set(a);
          setText('');
        });
      };
      const addCat = () => {
        if (!cat.trim()) return;
        db.ref(`todos/${dateKey}`).once('value').then(s => {
          const a = s.val() || [];
          a.push({ type: 'category', text: cat.trim() });
          db.ref(`todos/${dateKey}`).set(a);
          setCat('');
        });
      };
      const addDiv = () =>
        db.ref(`todos/${dateKey}`).once('value').then(s => {
          const a = s.val() || [];
          a.push({ type: 'divider' });
          db.ref(`todos/${dateKey}`).set(a);
        });
      const toggle = i =>
        db.ref(`todos/${dateKey}`).once('value').then(s => {
          const a = s.val() || [];
          if (a[i].type === 'todo') a[i].state = (a[i].state + 1) % 3;
          db.ref(`todos/${dateKey}`).set(a);
        });
      const remove = i =>
        db.ref(`todos/${dateKey}`).once('value').then(s => {
          const a = s.val() || [];
          a.splice(i, 1);
          db.ref(`todos/${dateKey}`).set(a);
        });
      const edit = i =>
        db.ref(`todos/${dateKey}`).once('value').then(s => {
          const a = s.val() || [];
          const v = prompt('Edit:', a[i].text);
          if (v != null && v.trim()) {
            a[i].text = v.trim();
            db.ref(`todos/${dateKey}`).set(a);
          }
        });

      // Ïù¥ÎØ∏ÏßÄ Ï∫°Ï≤ò & ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨
      const exportImg = async () => {
        await document.fonts.ready;
        const c = document.getElementById('export-container');
        c.style.background = '#fff';
        const canvas = await html2canvas(c, {
          scale: window.devicePixelRatio,
          backgroundColor: '#fff'
        });
        canvas.toBlob(async blob => {
          const perm = await navigator.permissions.query({ name: 'clipboard-write' });
          if (perm.state === 'granted' || perm.state === 'prompt') {
            await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
            alert('Ïù¥ÎØ∏ÏßÄÎ•º ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÌñàÏñ¥.');
          } else {
            alert('ÌÅ¥Î¶ΩÎ≥¥Îìú Í∂åÌïúÏù¥ ÌïÑÏöîÌï¥.');
          }
        });
      };

      // ÎÑ§ÎπÑÍ≤åÏù¥Ìä∏ Ïò§Îäò/Ïù¥Ï†ÑÎã§Ïùå Îã¨
      const navMonth = d => setDate(d);
      const goToday = () => setDate(getKST());

      // Îã¨Î†• Ï†ïÎ≥¥
      const year = date.getFullYear(),
            mo = date.getMonth(),
            days = new Date(year, mo + 1, 0).getDate(),
            start = new Date(year, mo, 1).getDay();

      return (
        <>
          <div className="sidebar">
            <h2>{year}<br/>{date.toLocaleString('en-US', { month: 'long' })}</h2>
            <div className="sidebar-controls">
              <button onClick={() => navMonth(new Date(year, mo - 1, 1))}>‚Üê</button>
              <button onClick={goToday}>Today</button>
              <button onClick={() => navMonth(new Date(year, mo + 1, 1))}>‚Üí</button>
            </div>
            <div className="calendar-grid">
              {weekdays.map((w,i)=>
                <div key={i} style={{ color: weekdayColors[i] }}>{w}</div>
              )}
              {Array(start).fill().map((_,i)=><div key={i}/>)}
              {Array(days).fill().map((_,i)=>{
                const dt = new Date(year, mo, i+1);
                const k = dt.toISOString().split('T')[0];
                return (
                  <button
                    key={i}
                    className={k===dateKey ? 'selected' : ''}
                    onClick={()=>setDate(dt)}
                  >
                    {i+1}
                  </button>
                );
              })}
            </div>
            <div className="sidebar-controls">
              <button onClick={()=>setView('notes')}>Notes</button>
            </div>
          </div>
          <div className="main">
            <div id="export-container" className="main-container">
              <h2>{date.toLocaleDateString('en-US',{
                weekday:'long',year:'numeric',month:'long',day:'numeric'
              })}</h2>
              {locked ? (
                <div
                  className="note-display"
                  style={{ color: colors[dateKey] || '#888888' }}
                  onDoubleClick={unlockNote}
                >
                  {note}
                </div>
              ) : (
                <textarea
                  className="note-input"
                  value={note}
                  onChange={e=>setNote(e.target.value)}
                  onKeyDown={e=>{
                    if(e.key==='Enter'&&!e.shiftKey){
                      e.preventDefault();
                      saveNote(note);
                      lockNote();
                    }
                  }}
                  placeholder="Ïò§ÎäòÏùò ÌïúÎßàÎîî"
                  rows={2}
                />
              )}
              <div className="section">
                <span>This date‚Äôs color: </span>
                <input
                  type="color"
                  value={colors[dateKey] || '#888888'}
                  onChange={saveColor}
                />
              </div>
              <textarea
                className="todo-input"
                value={text}
                onChange={e=>setText(e.target.value)}
                onKeyDown={e=>{
                  if(e.key==='Enter'&&!e.shiftKey){
                    e.preventDefault();
                    addTodo();
                  }
                }}
                placeholder="Ìï† Ïùº Ï∂îÍ∞Ä"
                rows={3}
              />
              <div className="section">
                <button className="secondary" onClick={addDiv}>Add Divider</button>
                <input
                  className="category-input"
                  value={cat}
                  onChange={e=>setCat(e.target.value)}
                  onKeyDown={e=>{ if(e.key==='Enter') addCat(); }}
                  placeholder="Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∂îÍ∞Ä"
                />
              </div>
              <div className="section">
                {todos.map((it,i)=>(
                  it.type==='divider' ? <hr key={i} className="divider"/> :
                  it.type==='category' ? <div key={i} style={{ fontWeight:600 }}>{it.text}</div> : (
                    <div
                      key={i}
                      className="todo-item"
                      draggable={editMode}
                      onDragStart={e=>e.currentTarget.classList.add('dragging')}
                      onDragEnd={e=>e.currentTarget.classList.remove('dragging')}
                      onClick={()=>!editMode&&toggle(i)}
                    >
                      <span className="bullet">{['‚òê','‚òë','‚òí'][it.state]}</span>
                      <span style={{ flex:1 }}>{it.text}</span>
                      {editMode&&<>
                        <button onClick={()=>edit(i)}>Edit</button>
                        <button onClick={()=>remove(i)}>Del</button>
                      </>}
                    </div>
                  )
                ))}
              </div>
              <div className="footer-buttons">
                <button className="action" onClick={exportImg}>Export as Image</button>
                <button className="secondary" onClick={()=>setEditMode(m=>!m)}>
                  {editMode?'Done':'Edit'}
                </button>
              </div>
            </div>
          </div>
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
