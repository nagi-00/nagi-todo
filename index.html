<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ùêù : ·¥Ö·¥Ä…™ ü è</title>
  <link rel="icon" href="./favi.ico" />
  <style>
    @font-face { font-family:'HJSS'; src:url('./HJSS.ttf') format('truetype'); }
    @font-face { font-family:'bbang'; src:url('./bbang.ttf') format('truetype'); }
    @font-face { font-family:'ywoo'; src:url('./ywoo.ttf') format('truetype'); }
    @font-face { font-family:'caa'; src:url('./caa.ttf') format('truetype'); }

    body { margin:0; padding:0; font-family:'HJSS',sans-serif; background:#f5f5f5; }
    .sidebar {
      position:fixed; left:0; top:0; bottom:0; width:16rem;
      background:#fff; overflow:auto;
      box-shadow:0 2px 5px rgba(0,0,0,0.1);
      padding:1rem;
    }
    .main {
      margin-left:16rem; padding:1rem;
      /* display:flex Ï†úÍ±∞ ‚Üí Î∏îÎ°ù Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨Îßå ÏÇ¨Ïö© */
    }

    .nav-btns {
      display:flex; justify-content:center; gap:0.5rem;
      margin:0.5rem 0; white-space:nowrap;
    }
    .nav-btns button {
      background:#fff; border:none;
      padding:0.5rem 1rem; cursor:pointer;
    }

    .toggle-btn {
      margin:1rem 0; width:100%; padding:0.5rem;
      border:none; background:#fff;
      cursor:pointer; font-weight:bold;
      border-radius:0.25rem; white-space:nowrap;
    }

    .calendar {
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:0.25rem; font-size:0.875rem;
    }
    .calendar-day { text-align:center; font-weight:500; }
    .calendar-date {
      width:1.8rem; height:1.8rem;
      display:flex; align-items:center; justify-content:center;
      background:#fff; border:none;
      border-radius:9999px;
      cursor:pointer; transition:background 0.2s;
    }
    .calendar-date.has-record {
      background: var(--highlight-color,#888)33;
      border-radius:9999px;
    }
    .calendar-date.highlight {
      background: var(--highlight-color,#888);
      color:#fff;
    }

    .note-area, .summary-area {
      max-width:42rem; background:#fff;
      border-radius:0.5rem;
      box-shadow:0 2px 5px rgba(0,0,0,0.1);
      padding:1.5rem; margin:0 auto;
    }

    .section { margin-bottom:1rem; }
    .section h2 { font-size:1.25rem; margin-bottom:0.5rem; }

    textarea {
      width:100%; padding:0.5rem; border:1px solid #ccc;
      border-radius:0.25rem; resize:vertical;
      font-family: inherit;
    }
    .color-picker {
      width:1.5rem; height:1.5rem; border:none;
      cursor:pointer; margin-bottom:1rem;
    }
    .font-select { margin-bottom:1rem; }
    .saved-text p { margin:0.25rem 0; }

    .mood-tracker button {
      font-size:1.5rem; padding:0.25rem;
      border:1px solid #ccc; border-radius:0.25rem;
      background:transparent; cursor:pointer;
      transition:border-color 0.2s, background 0.2s;
    }

    .export-region {
      background:#fff; border-radius:0.5rem;
      padding:2rem; /* Ï∂©Î∂ÑÌïú ÏïàÏ™Ω Ïó¨Î∞± */
      font-family: inherit;
    }
    .export-header { text-align:center; margin-bottom:1rem; }
    .export-header p { margin:0.25rem 0; font-weight:bold; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script type="text/babel">
    // Firebase Ï¥àÍ∏∞Ìôî
    const firebaseConfig = {
      apiKey: "AIzaSyBbM_NytZTqJSTPU74A9qYSskQ0GgXWtgw",
      authDomain: "nagi-daily.firebaseapp.com",
      databaseURL: "https://nagi-daily-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "nagi-daily",
      storageBucket: "nagi-daily.firebasestorage.app",
      messagingSenderId: "733658746377",
      appId: "1:733658746377:web:7537bfc577d37a1ab0b2d8"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Í∞êÏ†ï ÏÑ†ÌÉùÍ∏∞
    function MoodTracker({ dateKey, highlightColor }) {
      const [mood, setMood] = React.useState('');
      React.useEffect(() => {
        const ref = database.ref(`pages/${dateKey}/mood`);
        const off = ref.on('value', snap => setMood(snap.val() || ''));
        return () => ref.off('value', off);
      }, [dateKey]);

      const labels = { happy:'üòª', neutral:'üò∫', sad:'üòø', angry:'üòæ', excited:'‚ú®' };
      return (
        <div className="mood-tracker">
          {Object.entries(labels).map(([key, emoji]) => {
            const selected = mood === key;
            return (
              <button key={key}
                onClick={() => {
                  const next = selected ? '' : key;
                  database.ref(`pages/${dateKey}/mood`).set(next);
                }}
                style={{
                  background: selected ? highlightColor : 'transparent',
                  borderColor: selected ? highlightColor : '#ccc'
                }}>
                {emoji}
              </button>
            );
          })}
        </div>
      );
    }

    // Î™®Îãù/Í∞êÏÇ¨ ÏùºÍ∏∞
    function NoteArea({ dateKey, selectedDate, highlightColor, onColorChange }) {
      const [morning, setMorning] = React.useState('');
      const [gratitude, setGratitude] = React.useState('');
      const [editMorning, setEditMorning] = React.useState(false);
      const [editGratitude, setEditGratitude] = React.useState(false);
      const [font, setFont] = React.useState('HJSS');

      React.useEffect(() => {
        const mRef = database.ref(`pages/${dateKey}/morning`);
        const gRef = database.ref(`pages/${dateKey}/gratitude`);
        mRef.on('value', snap => {
          const v = snap.val() || '';
          setMorning(v); setEditMorning(v === '');
        });
        gRef.on('value', snap => {
          const v = snap.val() || '';
          setGratitude(v); setEditGratitude(v === '');
        });
        return () => { mRef.off(); gRef.off(); };
      }, [dateKey]);

      const handleKeyDown = (e, text, setFn, path, setEdit) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          database.ref(path).set(text);
          setEdit(false);
        }
      };

      const exportImage = async () => {
        await document.fonts.ready;
        const el = document.querySelector('.export-region');
        const canvas = await html2canvas(el, { backgroundColor:'#fff', scale:2 });
        canvas.toBlob(blob => {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `daily-${dateKey}.png`;
          a.click();
        });
      };

      // ÎÇ†Ïßú/ÏöîÏùº
      const y = selectedDate.getFullYear(),
            mo = String(selectedDate.getMonth()+1).padStart(2,'0'),
            d  = String(selectedDate.getDate()).padStart(2,'0'),
            wd = selectedDate.toLocaleDateString('en-US',{weekday:'short'});
      const displayDate = `${y}-${mo}-${d} (${wd})`;

      return (
        <div className="note-area" style={{ fontFamily: font }}>
          {/* ÏÑ§Ï†ï UI */}
          <select value={font} className="font-select" onChange={e=>setFont(e.target.value)}>
            <option value="HJSS">HJSS</option>
            <option value="ywoo">ywoo</option>
            <option value="bbang">bbang</option>
            <option value="caa">caa</option>
          </select>
          <input type="color" className="color-picker" value={highlightColor}
            onChange={e=>onColorChange(e.target.value)} />

          {/* Ï∫°Ï≤ò ÎåÄÏÉÅ */}
          <div className="export-region" style={{ fontFamily: font }}>
            <div className="export-header"><p>{displayDate}</p></div>
            <div className="section">
              <h2 style={{ color: highlightColor }}>·¥ç·¥è Ä…¥…™…¥…¢</h2>
              {editMorning
                ? <textarea rows={4} value={morning}
                    onChange={e=>setMorning(e.target.value)}
                    onKeyDown={e=>handleKeyDown(e, morning, setMorning,
                                               `pages/${dateKey}/morning`,
                                               setEditMorning)}
                    style={{ borderColor: highlightColor }}
                    placeholder="Î™®ÎãùÌéòÏù¥ÏßÄ" />
                : <div className="saved-text" onDoubleClick={()=>setEditMorning(true)}>
                    {morning.split('\n').map((line,i)=><p key={i}>{line}</p>)}
                  </div>
              }
            </div>
            <MoodTracker dateKey={dateKey} highlightColor={highlightColor} />
            <div className="section">
              <h2 style={{ color: highlightColor }}>·¥á·¥†·¥á…¥…™…¥…¢</h2>
              {editGratitude
                ? <textarea rows={4} value={gratitude}
                    onChange={e=>setGratitude(e.target.value)}
                    onKeyDown={e=>handleKeyDown(e, gratitude, setGratitude,
                                               `pages/${dateKey}/gratitude`,
                                               setEditGratitude)}
                    style={{ borderColor: highlightColor }}
                    placeholder="Í∞êÏÇ¨ÏùºÍ∏∞" />
                : <div className="saved-text" onDoubleClick={()=>setEditGratitude(true)}>
                    {gratitude.split('\n').map((line,i)=><p key={i}>{line}</p>)}
                  </div>
              }
            </div>
          </div>

          <button onClick={exportImage}
            style={{
              marginTop:'1rem', padding:'.5rem',
              background: highlightColor, color:'#fff',
              border:'none', borderRadius:'.25rem',
              cursor:'pointer'
            }}>
            Export Image
          </button>
        </div>
      );
    }

    // ÏõîÎ≥Ñ ÏöîÏïΩ
    function MonthlySummary({ year, month }) {
      const [counts, setCounts] = React.useState(null);
      React.useEffect(() => {
        database.ref('pages').once('value', snap => {
          const data = snap.val()||{};
          const mc={happy:0,neutral:0,sad:0,angry:0,excited:0};
          Object.entries(data).forEach(([day,val])=>{
            const dt=new Date(day);
            if(dt.getFullYear()===year && dt.getMonth()===month && val.mood){
              mc[val.mood]=(mc[val.mood]||0)+1;
            }
          });
          setCounts(mc);
        });
      }, [year,month]);
      if(!counts) return <div className="summary-area"><p> üá≥ üá¥ üáº  üá± üá¥ üá¶ üá© üáÆ üá≥ üá¨ </p></div>;
      const labels={happy:'üòª',neutral:'üò∫',sad:'üòø',angry:'üòæ',excited:'‚ú®'};
      return (
        <div className="summary-area">
          {Object.entries(labels).map(([k,emoji])=>(
            <p key={k}>{emoji} {counts[k]||0}</p>
          ))}
        </div>
      );
    }

    // DiscordBotWidget
    function DiscordBotWidget() {
      const [isVisible,setIsVisible]=React.useState(false);
      const [lastMessage,setLastMessage]=React.useState('');
      const [isOnline,setIsOnline]=React.useState(false);
      const isFocusTime=()=>{
        const now=new Date(), day=now.getDay(), hour=now.getHours();
        const ranges={1:[6,13],2:[6,18],3:[6,13],4:[6,18],5:[6,21]};
        const r=ranges[day];
        return r&&hour>=r[0]&&hour<r[1];
      };
      React.useEffect(()=>{
        const updateStatus=async()=>{
          const online=isFocusTime(); setIsOnline(online);
          if(online){
            try{
              const res=await fetch("https://raw.githubusercontent.com/nagi-00/nagi-todo/main/demian_focus_messages.json");
              const data=await res.json();
              setLastMessage(data.messages[Math.floor(Math.random()*data.messages.length)]);
            }catch{ setLastMessage("Î©îÏãúÏßÄÎ•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏñ¥."); }
          }
        };
        updateStatus(); const timer=setInterval(updateStatus,60000);
        return()=>clearInterval(timer);
      }, []);
      return(<>
        <div onClick={()=>setIsVisible(v=>!v)} style={{
          position:'fixed', bottom:'20px', right:'20px', width:'60px', height:'60px',
          borderRadius:'50%', background:isOnline?'#CECECE':'#ccc',
          display:'flex', alignItems:'center', justifyContent:'center',
          cursor:'pointer', zIndex:1000
        }}>
          <span style={{fontSize:'24px',color:'#fff'}}>üñ§</span>
        </div>
        {isVisible&&(
          <div style={{
            position:'fixed', bottom:'100px', right:'20px', width:'300px',
            background:'#fff', borderRadius:'15px', padding:'20px',
            boxShadow:'0 8px 25px rgba(0,0,0,0.15)', zIndex:999
          }}>
            {isOnline?(
              <>
                <div style={{fontWeight:'bold',fontSize:'15px',marginBottom:'0.5rem'}}>·¥Ö·¥á·¥ç…™·¥Ä…¥</div>
                <div style={{fontSize:'14px',color:'#333'}}>{lastMessage}</div>
              </>
            ):(
              <>          
                <div style={{textAlign:'center',color:'#888',fontSize:'14px'}}>üò¥ Ìú¥ÏãùÏùò ÏãúÍ∞ÑÏù¥Ïïº.</div>
                <div style={{fontSize:'12px',marginTop:'8px',textAlign:'center'}}>
                  ùóôùóºùó∞ùòÇùòÄ ùóßùó∂ùó∫ùó≤<br/>
                  M (06-13)<br/>T (06-18)<br/>W (06-13)<br/>T (06-18)<br/>F (06-21)
                </div>
              </>
            )}
          </div>
        )}
      </>);
    }

    // Î©îÏù∏ Ïï±
    function App() {
      const [view,setView]=React.useState('daily');
      const [selectedDate,setSelectedDate]=React.useState(new Date());
      const [allPages,setAllPages]=React.useState({});
      const [highlightColor,setHighlightColor]=React.useState('#888888');

      React.useEffect(()=>{
        const ref=database.ref('pages');
        ref.on('value',snap=>setAllPages(snap.val()||{}));
        return()=>ref.off();
      }, []);

      const dateKey=selectedDate.toLocaleDateString('sv-SE');
      React.useEffect(()=>{
        const cref=database.ref(`pages/${dateKey}/color`);
        const off=cref.on('value',snap=>setHighlightColor(snap.val()||'#888888'));
        return()=>cref.off('value',off);
      }, [dateKey]);

      const prev=()=>setSelectedDate(d=>new Date(d.getFullYear(),d.getMonth()-1,1));
      const next=()=>setSelectedDate(d=>new Date(d.getFullYear(),d.getMonth()+1,1));
      const today=()=>setSelectedDate(new Date());

      const year=selectedDate.getFullYear();
      const month=selectedDate.getMonth();
      const firstDay=new Date(year,month,1).getDay();
      const dayCount=new Date(year,month+1,0).getDate();
      const weekdays=['S','M','T','W','T','F','S'];

      return(<>
        <div style={{display:'flex'}}>
          <div className="sidebar">
            <h2 style={{textAlign:'center',whiteSpace:'pre-line',marginBottom:'1rem'}}>
              {year}{'\n'}{selectedDate.toLocaleDateString('en-US',{month:'long'})}
            </h2>
            <div className="nav-btns">
              <button onClick={prev}>‚Üê</button>
              <button onClick={today}>Today</button>
              <button onClick={next}>‚Üí</button>
            </div>
            <button className="toggle-btn"
              onClick={()=>setView(v=>v==='daily'?'monthly':'daily')}>
              {view==='daily'?'üá≤ üá¥ üá≥ üáπ üá≠ üá± üáæ':'üá∑ üá™ üáπ üá∫ üá∑ üá≥'}
            </button>
            <div className="calendar" style={{'--highlight-color':highlightColor}}>
              {weekdays.map((d,i)=><div key={i} className="calendar-day"
                style={{color:i===0?'#8A4545':i===6?'#434A8E':'#666'}}>{d}</div>)}
              {Array(firstDay).fill().map((_,i)=><div key={`e${i}`}/>)} 
              {Array.from({length:dayCount}).map((_,i)=>{
                const dt=new Date(year,month,i+1);
                const key=dt.toLocaleDateString('sv-SE');
                const sel=key===dateKey, rec=Boolean(allPages[key]);
                const cls=['calendar-date',sel?'highlight':'',!sel&&rec?'has-record':''].join(' ');
                return(<button key={i} className={cls}
                  onClick={()=>{setSelectedDate(dt);setView('daily');}}>{i+1}</button>);
              })}
            </div>
          </div>
          <div className="main">
            {view==='daily'
              ? <NoteArea
                  dateKey={dateKey}
                  selectedDate={selectedDate}
                  highlightColor={highlightColor}
                  onColorChange={c=>database.ref(`pages/${dateKey}/color`).set(c)}
                />
              : <MonthlySummary year={year} month={month} />
            }
          </div>
        </div>
        <DiscordBotWidget />
      </>);
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
