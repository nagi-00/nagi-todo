<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ùêù : ·¥õ·¥è·¥Ö·¥è</title>
  <link rel="icon" href="./favi.ico" type="image/x-icon" />
  <style>
    @font-face {
      font-family: 'HJSS';
      src: url('./HJSS.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'HJSS', sans-serif;
      background: #f5f5f5;
      box-sizing: border-box;
    }
    *, *::before, *::after {
      box-sizing: inherit;
    }
    .edit-delete-btn {
      font-size: 0.75rem;
      color: #888;
      background: none;
      border: none;
      cursor: pointer;
      margin-left: 0.5rem;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React, ReactDOM, Babel (CDN) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (v9 compat) - Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>

  <!-- html2canvas for image export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script type="text/babel">
    // Firebase ÏÑ§Ï†ï
    const firebaseConfig = {
      apiKey: "AIzaSyAa-8IWlzzPflkV6Iqzunha5TCnMXclTns",
      authDomain: "nagi-todo.firebaseapp.com",
      databaseURL: "https://nagi-todo-default-rtdb.firebaseio.com/",
      projectId: "nagi-todo",
      storageBucket: "nagi-todo.firebasestorage.app",
      messagingSenderId: "923414063910",
      appId: "1:923414063910:web:e09c59bc3cc72a19686fe7"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // KST Í∏∞Ï§Ä ÌòÑÏû¨ ÏãúÍ∞Ñ Î∞òÌôò
    function getSeoulDate() {
      return new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
    }

    function App() {
      const [text, setText] = React.useState('');
      const [categoryText, setCategoryText] = React.useState('');
      const [selectedDate, setSelectedDate] = React.useState(getSeoulDate());
      const [showSidebar, setShowSidebar] = React.useState(true);
      const [allTodos, setAllTodos] = React.useState({});
      const [accentColor, setAccentColor] = React.useState('#888888'); // Í∏∞Î≥∏ ÌöåÏÉâ
      const [dateColors, setDateColors] = React.useState({});
      const [noteText, setNoteText] = React.useState('');
      const [notes, setNotes] = React.useState({});
      const [showNotesList, setShowNotesList] = React.useState(false);
      const [notesEditMode, setNotesEditMode] = React.useState(false);
      const [editMode, setEditMode] = React.useState(false);
      const [draggedItem, setDraggedItem] = React.useState(null);
      const [draggedOverItem, setDraggedOverItem] = React.useState(null);

      const bulletStates = ['‚òê', '‚òë', '‚òí'];
      const dateKey = selectedDate.toISOString().split('T')[0];
      const items = allTodos[dateKey] || [];

      // ÎÇ†ÏßúÎ≥Ñ todos Íµ¨ÎèÖ
      React.useEffect(() => {
        const ref = database.ref('todos/' + dateKey);
        const handler = ref.on('value', snap => {
          setAllTodos(prev => ({ ...prev, [dateKey]: snap.val() || [] }));
        });
        return () => ref.off('value', handler);
      }, [dateKey]);

      // ÎÇ†ÏßúÎ≥Ñ Ïª¨Îü¨ Íµ¨ÎèÖ
      React.useEffect(() => {
        const ref = database.ref('dateColors');
        const handler = ref.on('value', snap => {
          setDateColors(snap.val() || {});
        });
        return () => ref.off('value', handler);
      }, []);

      // Notes Íµ¨ÎèÖ (ÌòÑÏû¨ ÎÇ†Ïßú)
      React.useEffect(() => {
        setNotesEditMode(false);
        const ref = database.ref('notes/' + dateKey);
        const handler = ref.on('value', snap => {
          setNoteText(snap.val() || '');
        });
        return () => ref.off('value', handler);
      }, [dateKey]);

      // Î™®Îì† Notes Íµ¨ÎèÖ
      React.useEffect(() => {
        const ref = database.ref('notes');
        const handler = ref.on('value', snap => {
          setNotes(snap.val() || {});
        });
        return () => ref.off('value', handler);
      }, []);

      // accentColor Î°úÏª¨ Ï†ÄÏû•ÏÜåÎäî Í∑∏ÎåÄÎ°ú Ïú†ÏßÄÌï¥ÎèÑ Î¨¥Î∞©
      React.useEffect(() => {
        const saved = localStorage.getItem('accentColor');
        if (saved) setAccentColor(saved);
      }, []);
      React.useEffect(() => {
        localStorage.setItem('accentColor', accentColor);
      }, [accentColor]);

      // ÎÇ†Ïßú Ïù¥Îèô
      function handlePrevMonth() {
        setSelectedDate(prev => new Date(prev.getFullYear(), prev.getMonth() - 1, 1));
      }
      function handleNextMonth() {
        setSelectedDate(prev => new Date(prev.getFullYear(), prev.getMonth() + 1, 1));
      }
      function handleToday() {
        setSelectedDate(getSeoulDate());
      }

      // Ìï† Ïùº Ï∂îÍ∞Ä
      function handleKeyDownTodo(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (text.trim()) {
            database.ref('todos/' + dateKey).set([
              ...(items),
              { type: 'todo', text: text.trim(), state: 0 }
            ]);
            setText('');
          }
        }
      }
      function handleKeyDownCategory(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (categoryText.trim()) {
            database.ref('todos/' + dateKey).set([
              ...(items),
              { type: 'category', text: categoryText.trim() }
            ]);
            setCategoryText('');
          }
        }
      }
      function addDivider() {
        database.ref('todos/' + dateKey).set([
          ...items,
          { type: 'divider' }
        ]);
      }

      // ÏÉÅÌÉú ÌÜ†Í∏Ä (ÌÅ¥Î¶≠, Íæπ ÎàÑÎ•¥Í∏∞)
      function toggleState(index) {
        if (editMode) return;
        const updated = items.map((it, i) =>
          i === index && it.type === 'todo'
            ? { ...it, state: (it.state + 1) % bulletStates.length }
            : it
        );
        database.ref('todos/' + dateKey).set(updated);
      }

      // ÏÇ≠Ï†ú / Ìé∏Ïßë
      function deleteItem(index) {
        const filtered = items.filter((_, i) => i !== index);
        database.ref('todos/' + dateKey).set(filtered);
      }
      function editItem(index) {
        const it = items[index];
        if (!it) return;
        const newText = prompt('Edit text:', it.text);
        if (newText != null && newText.trim()) {
          const copy = [...items];
          copy[index].text = newText.trim();
          database.ref('todos/' + dateKey).set(copy);
        }
      }

      // Notes ÏûÖÎ†• Ï†ÄÏû•
      function handleKeyDownNote(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          database.ref('notes/' + dateKey).set(noteText.trim());
          setNotesEditMode(false);
        }
      }

      // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ (editMode)
      function handleDragStart(e, idx) {
        if (!editMode) return;
        setDraggedItem(idx);
        e.currentTarget.style.opacity = '0.4';
      }
      function handleDragEnd(e) {
        if (!editMode) return;
        e.currentTarget.style.opacity = '1';
        setDraggedItem(null);
        setDraggedOverItem(null);
      }
      function handleDragOver(e, idx) {
        if (!editMode) return;
        e.preventDefault();
        setDraggedOverItem(idx);
      }
      function handleDrop(e, idx) {
        if (!editMode) return;
        e.preventDefault();
        const copy = [...items];
        const moved = copy.splice(draggedItem, 1)[0];
        copy.splice(idx, 0, moved);
        database.ref('todos/' + dateKey).set(copy);
        setDraggedItem(null);
        setDraggedOverItem(null);
      }

      // Ïù¥ÎØ∏ÏßÄ ÎÇ¥Î≥¥ÎÇ¥Í∏∞
      async function exportAsImage() {
        const container = document.querySelector('.todo-container');
        const canvas = await html2canvas(container, { backgroundColor: '#fff' });
        canvas.toBlob(async blob => {
          try {
            await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
            alert('ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Ïù¥ÎØ∏ÏßÄÎ•º Î≥µÏÇ¨ÌñàÏñ¥.');
          } catch {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `todo-${dateKey}.png`;
            a.click();
            URL.revokeObjectURL(url);
            alert('Ïù¥ÎØ∏ÏßÄÎ•º Îã§Ïö¥Î°úÎìúÌñàÏñ¥.');
          }
        });
      }

      // Îã¨Î†• Í¥ÄÎ†® Í≥ÑÏÇ∞
      const daysInMonth = new Date(
        selectedDate.getFullYear(),
        selectedDate.getMonth() + 1, 0
      ).getDate();
      const firstDay = new Date(
        selectedDate.getFullYear(),
        selectedDate.getMonth(), 1
      ).getDay();
      const isToday = dateKey === getSeoulDate().toISOString().split('T')[0];

      // Ìïú ÎÇ†ÏßúÏóê Ìï† Ïùº Ïú†Î¨¥
      const hasTodos = d => {
        const key = d.toISOString().split('T')[0];
        return allTodos[key] && allTodos[key].length > 0;
      };

      return (
        <div style={{ display:'flex', minHeight:'100vh' }}>
          <button onClick={()=>setShowSidebar(v=>!v)}
            style={{
              position:'fixed', left:'1rem', top:'1rem', zIndex:10,
              background:'#fff', padding:'0.5rem', borderRadius:'9999px',
              boxShadow:'0 2px 5px rgba(0,0,0,0.1)', cursor:'pointer'
            }}
            className="md:hidden"
          >
            {showSidebar ? '‚Üê' : '‚Üí'}
          </button>

          <div style={{
            position:'fixed', left:0, top:0, bottom:0, width:'16rem',
            background:'#fff', boxShadow:'0 2px 5px rgba(0,0,0,0.1)',
            zIndex:20, overflow:'auto',
            transform: showSidebar ? 'translateX(0)' : 'translateX(-100%)',
            transition:'transform 0.3s ease-in-out'
          }}>
            <div style={{ padding:'1rem' }}>
              <h2 style={{
                fontWeight:'bold', whiteSpace:'pre-line', textAlign:'center',
                marginBottom:'1rem'
              }}>
                {selectedDate.toLocaleString('en-US',{ year:'numeric'})}{'\n'}
                {selectedDate.toLocaleString('en-US',{ month:'long'})}
              </h2>

              <div style={{
                display:'flex', justifyContent:'center', gap:'0.5rem',
                margin:'0.5rem 0'
              }}>
                <button onClick={handlePrevMonth}
                  style={{
                    background:'#fff', border:'none', padding:'0.25rem 0.5rem',
                    cursor:'pointer'
                  }}>‚Üê</button>
                <button onClick={handleToday}
                  style={{
                    background:'#fff', border:'none', padding:'0.25rem 0.5rem',
                    cursor:'pointer'
                  }}>Today</button>
                <button onClick={handleNextMonth}
                  style={{
                    background:'#fff', border:'none', padding:'0.25rem 0.5rem',
                    cursor:'pointer'
                  }}>‚Üí</button>
              </div>

              <button onClick={()=>setShowNotesList(v=>!v)}
                style={{
                  width:'100%', padding:'0.5rem', marginBottom:'1rem',
                  background:'#f0f0f0', border:'none', cursor:'pointer'
                }}
              >
                {showNotesList ? 'Back' : 'Notes'}
              </button>

              {showNotesList ? (
                Object.entries(notes)
                  .sort((a,b)=>b[0].localeCompare(a[0]))
                  .map(([d,text])=>(
                    <div key={d} style={{
                      background:'#fff', borderRadius:'0.5rem',
                      padding:'0.75rem', marginBottom:'0.5rem',
                      boxShadow:'0 1px 3px rgba(0,0,0,0.1)'
                    }}>
                      <div style={{
                        fontWeight:'600', marginBottom:'0.25rem'
                      }}>
                        {new Date(d).toLocaleString('en-US',{
                          weekday:'long', year:'numeric',
                          month:'long', day:'numeric'
                        })}
                      </div>
                      <div style={{
                        fontWeight:'bold',
                        color: dateColors[d] || accentColor
                      }}>{text}</div>
                    </div>
                  ))
              ) : (
                <div style={{
                  display:'grid',
                  gridTemplateColumns:'repeat(7,1fr)',
                  gap:'0.25rem', fontSize:'0.875rem'
                }}>
                  {['S','M','T','W','T','F','S'].map(d=>(
                    <div key={d} style={{
                      textAlign:'center', fontWeight:'500', color:'#666'
                    }}>{d}</div>
                  ))}
                  {Array(firstDay).fill(null).map((_,i)=>(
                    <div key={`empty-${i}`}/>
                  ))}
                  {Array.from({ length: daysInMonth },(_,i)=>{
                    const dateObj = new Date(
                      selectedDate.getFullYear(),
                      selectedDate.getMonth(),
                      i+1
                    );
                    const dKey = dateObj.toISOString().split('T')[0];
                    const isSel = dKey === dateKey;
                    const circleColor = dateColors[dKey] || accentColor;
                    return (
                      <button key={i}
                        onClick={()=>{
                          setSelectedDate(dateObj);
                          if(window.innerWidth<768) setShowSidebar(false);
                        }}
                        style={{
                          width:'1.8rem', height:'1.8rem', margin:'0 auto',
                          display:'flex', alignItems:'center',
                          justifyContent:'center',
                          border: isToday&& !isSel?'1px solid #ccc':'none',
                          backgroundColor: isSel?circleColor:'transparent',
                          color: isSel?'#fff':'#000',
                          borderRadius:'9999px',
                          cursor:'pointer', position:'relative'
                        }}
                      >
                        <span>{i+1}</span>
                        {hasTodos(dateObj)&&(
                          <span style={{
                            fontSize:'0.75rem',
                            color: isSel?'#fff':circleColor,
                            position:'absolute', bottom:'-0.3rem'
                          }}>‚Ä¢</span>
                        )}
                      </button>
                    );
                  })}
                </div>
              )}
            </div>
          </div>

          <div style={{
            flex:1, padding:'1rem',
            marginLeft: showSidebar?'16rem':'0',
            transition:'margin-left 0.3s'
          }}>
            <div className="todo-container" style={{
              maxWidth:'42rem', margin:'0 auto', background:'#fff',
              borderRadius:'0.5rem', boxShadow:'0 2px 5px rgba(0,0,0,0.1)',
              padding:'1.5rem'
            }}>
              <h2 style={{
                fontSize:'1.25rem', fontWeight:'bold', marginBottom:'1rem'
              }}>
                {selectedDate.toLocaleString('en-US',{
                  weekday:'long', year:'numeric',
                  month:'long', day:'numeric'
                })}
              </h2>

              {(!notesEditMode && noteText.trim()) ? (
                <div style={{
                  fontWeight:'bold',
                  color: dateColors[dateKey]||accentColor,
                  marginBottom:'1rem', whiteSpace:'pre-wrap'
                }}
                onDoubleClick={()=>setNotesEditMode(true)}
                onContextMenu={e=>{e.preventDefault();setNotesEditMode(true);}}>
                  {noteText}
                </div>
              ) : (
                <textarea
                  value={noteText}
                  onChange={e=>setNoteText(e.target.value)}
                  onKeyDown={handleKeyDownNote}
                  placeholder="Notes (Enter Ï†ÄÏû•, Shift+Enter Ï§ÑÎ∞îÍøà)"
                  rows={2}
                  style={{
                    width:'100%', border:'1px solid #ccc',
                    padding:'0.5rem', borderRadius:'0.25rem',
                    resize:'vertical', fontWeight:'bold',
                    color: dateColors[dateKey]||accentColor,
                    marginBottom:'1rem'
                  }}
                />
              )}

              <div style={{
                display:'grid', gridTemplateColumns:'auto 1fr',
                columnGap:'0.5rem', rowGap:'0.75rem'
              }}>
                <textarea
                  value={text}
                  onChange={e=>setText(e.target.value)}
                  onKeyDown={handleKeyDownTodo}
                  placeholder="Add a task (Enter Ï†ÄÏû•, Shift+Enter Ï§ÑÎ∞îÍøà)"
                  rows={3}
                  style={{
                    gridColumn:'1 / 3', border:'1px solid #ccc',
                    padding:'0.5rem', borderRadius:'0.25rem',
                    resize:'vertical'
                  }}
                />
                <button onClick={addDivider}
                  style={{
                    padding:'0.5rem 0.75rem', fontSize:'0.875rem',
                    background:'#f0f0f0', border:'none',
                    borderRadius:'0.25rem', cursor:'pointer'
                  }}>Add Divider</button>
                <input
                  type="text"
                  value={categoryText}
                  onChange={e=>setCategoryText(e.target.value)}
                  onKeyDown={handleKeyDownCategory}
                  placeholder="Add category..."
                  style={{
                    border:'1px solid #ccc', padding:'0.25rem',
                    borderRadius:'0.25rem', fontSize:'0.875rem'
                  }}
                />
              </div>

              <div style={{
                marginTop:'1rem', display:'flex',
                flexDirection:'column', gap:'0.5rem'
              }}>
                {items.map((item,i)=>{
                  const dndProps = editMode?{
                    draggable:true,
                    onDragStart:e=>handleDragStart(e,i),
                    onDragEnd:handleDragEnd,
                    onDragOver:e=>handleDragOver(e,i),
                    onDrop:e=>handleDrop(e,i)
                  }:{};

                  if(item.type==='divider'){
                    return (
                      <div key={i} style={{
                        position:'relative',
                        borderTop:editMode&&draggedOverItem===i?`2px solid ${accentColor}`:'none',
                        margin:'0.5rem 0'
                      }} {...dndProps}>
                        <hr style={{
                          borderTop:`1px solid ${accentColor}`,
                          margin:'0.5rem 0'
                        }}/>
                        {editMode&&(
                          <div style={{ textAlign:'right' }}>
                            <button className="edit-delete-btn" onClick={()=>deleteItem(i)}>Delete</button>
                          </div>
                        )}
                      </div>
                    );
                  }
                  if(item.type==='category'){
                    return (
                      <div key={i} style={{
                        display:'flex', justifyContent:'space-between',
                        alignItems:'center',
                        cursor:editMode?'move':'default',
                        borderTop:editMode&&draggedOverItem===i?`2px solid ${accentColor}`:'none'
                      }} {...dndProps}>
                        <div style={{ fontWeight:'600', color:'#555' }}>{item.text}</div>
                        {editMode&&(
                          <>
                            <button className="edit-delete-btn" onClick={()=>editItem(i)}>Edit</button>
                            <button className="edit-delete-btn" onClick={()=>deleteItem(i)}>Delete</button>
                          </>
                        )}
                      </div>
                    );
                  }
                  return (
                    <div key={i} style={{
                      display:'flex', alignItems:'center', gap:'0.5rem',
                      padding:'0.5rem', borderRadius:'0.25rem',
                      cursor:editMode?'move':'default',
                      background:'#fafafa',
                      borderTop:editMode&&draggedOverItem===i?`2px solid ${accentColor}`:'none'
                    }} {...dndProps}>
                      <span
                        onClick={e=>{e.stopPropagation(); toggleState(i);}}
                        onContextMenu={e=>{e.preventDefault(); toggleState(i);}}
                        style={{
                          color:accentColor, fontFamily:'monospace',
                          fontSize:'1.25rem',
                          cursor:editMode?'default':'pointer'
                        }}
                      >
                        {bulletStates[item.state]}
                      </span>
                      <span style={{ flex:1, whiteSpace:'pre-wrap' }}>
                        {item.text}
                      </span>
                      {editMode&&(
                        <>
                          <button className="edit-delete-btn" onClick={()=>editItem(i)}>Edit</button>
                          <button className="edit-delete-btn" onClick={()=>deleteItem(i)}>Delete</button>
                        </>
                      )}
                    </div>
                  );
                })}
              </div>

              <div style={{ display:'flex', gap:'0.5rem', marginTop:'1rem' }}>
                {items.length>0 && (
                  <button onClick={exportAsImage} style={{
                    flex:1, padding:'0.5rem',
                    background:accentColor, color:'#fff',
                    border:'none', borderRadius:'0.25rem',
                    cursor:'pointer'
                  }}>Export as Image</button>
                )}
                <button onClick={()=>setEditMode(v=>!v)} style={{
                  flex: items.length>0?'unset':1,
                  padding:'0.5rem', fontSize:'0.875rem',
                  background:editMode?'#dddddd':'#f0f0f0',
                  border:'none', borderRadius:'0.25rem',
                  cursor:'pointer'
                }}>{editMode?'Done':'Edit'}</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
