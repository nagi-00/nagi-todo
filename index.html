<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ùêù : ·¥õ·¥è·¥Ö·¥è</title>
  <link rel="icon" href="./favi.ico" type="image/x-icon" />
  <style>
    @font-face {
      font-family: 'HJSS';
      src: url('./HJSS.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'HJSS', sans-serif;
      background: #f5f5f5;
      box-sizing: border-box;
    }
    *, *::before, *::after {
      box-sizing: inherit;
    }
    .edit-delete-btn {
      font-size: 0.75rem;
      color: #888;
      background: none;
      border: none;
      cursor: pointer;
      margin-left: 0.5rem;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React, ReactDOM, Babel (CDN) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>

  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script type="text/babel">
    // Firebase Ï¥àÍ∏∞Ìôî
    const firebaseConfig = {
      apiKey: "AIzaSyAa-8IWlzzPflkV6Iqzunha5TCnMXclTns",
      authDomain: "nagi-todo.firebaseapp.com",
      databaseURL: "https://nagi-todo-default-rtdb.firebaseio.com/",
      projectId: "nagi-todo",
      storageBucket: "nagi-todo.firebasestorage.app",
      messagingSenderId: "923414063910",
      appId: "1:923414063910:web:e09c59bc3cc72a19686fe7"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // KST Ï†ïÌôïÌïòÍ≤å Í≥ÑÏÇ∞
    function getSeoulDate() {
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset() * 60000;
      const kstOffset = 9 * 60 * 60000;
      return new Date(utc + kstOffset);
    }

    function App() {
      const [selectedDate, setSelectedDate] = React.useState(getSeoulDate());
      const [showSidebar, setShowSidebar] = React.useState(true);
      const [allTodos, setAllTodos] = React.useState({});
      const [accentColor, setAccentColor] = React.useState('#888888');
      const [dateColors, setDateColors] = React.useState({});
      const [noteText, setNoteText] = React.useState('');
      const [notes, setNotes] = React.useState({});
      const [showNotesList, setShowNotesList] = React.useState(false);
      const [notesEditMode, setNotesEditMode] = React.useState(false);
      const [editMode, setEditMode] = React.useState(false);
      const [draggedItem, setDraggedItem] = React.useState(null);
      const [draggedOverItem, setDraggedOverItem] = React.useState(null);

      const [textNec, setTextNec] = React.useState('');
      const [textGro, setTextGro] = React.useState('');
      const [textFree, setTextFree] = React.useState('');

      const bulletStates = ['‚òê','‚òë','‚òí'];
      const categories = ['ÌïÑÏó∞Ïùò ÏãúÍ∞Ñ','ÏÑ±Ïû•Ïùò ÏãúÍ∞Ñ','ÏûêÏú†Ïùò ÏãúÍ∞Ñ'];
      const dateKey = selectedDate.toISOString().split('T')[0];
      const items = allTodos[dateKey] || [];

      const tasksByCategory = categories.map(cat =>
        items
          .map((it, i) => it.type === 'todo' && it.category === cat ? { ...it, index: i } : null)
          .filter(x => x)
      );

      // Firebase Íµ¨ÎèÖ: todos
      React.useEffect(() => {
        const ref = database.ref('todos/' + dateKey);
        const handler = ref.on('value', snap => {
          setAllTodos(prev => ({ ...prev, [dateKey]: snap.val() || [] }));
        });
        return () => ref.off('value', handler);
      }, [dateKey]);

      // Firebase Íµ¨ÎèÖ: dateColors
      React.useEffect(() => {
        const ref = database.ref('dateColors');
        const handler = ref.on('value', snap => {
          setDateColors(snap.val() || {});
        });
        return () => ref.off('value', handler);
      }, []);

      // Firebase Íµ¨ÎèÖ: notes
      React.useEffect(() => {
        setNotesEditMode(false);
        const ref = database.ref('notes/' + dateKey);
        const handler = ref.on('value', snap => {
          setNoteText(snap.val() || '');
        });
        return () => ref.off('value', handler);
      }, [dateKey]);

      // Firebase Íµ¨ÎèÖ: all notes
      React.useEffect(() => {
        const ref = database.ref('notes');
        const handler = ref.on('value', snap => {
          setNotes(snap.val() || {});
        });
        return () => ref.off('value', handler);
      }, []);

      // accentColor Î°úÏª¨ Ï†ÄÏû•
      React.useEffect(() => {
        const saved = localStorage.getItem('accentColor');
        if (saved) setAccentColor(saved);
      }, []);
      React.useEffect(() => {
        localStorage.setItem('accentColor', accentColor);
      }, [accentColor]);

      function handlePrevMonth() {
        setSelectedDate(prev => new Date(prev.getFullYear(), prev.getMonth() - 1, 1));
      }
      function handleNextMonth() {
        setSelectedDate(prev => new Date(prev.getFullYear(), prev.getMonth() + 1, 1));
      }
      function handleToday() {
        setSelectedDate(getSeoulDate());
        setShowNotesList(false);
      }

      function addTodo(cat, text, setter) {
        if (!text.trim()) return;
        database.ref('todos/' + dateKey).set([...items, { type: 'todo', category: cat, text: text.trim(), state: 0 }]);
        setter('');
      }
      function handleKeyDownNec(e) { if (e.key==='Enter'&& !e.shiftKey){ e.preventDefault(); addTodo('ÌïÑÏó∞Ïùò ÏãúÍ∞Ñ', textNec, setTextNec); }}
      function handleKeyDownGro(e) { if (e.key==='Enter'&& !e.shiftKey){ e.preventDefault(); addTodo('ÏÑ±Ïû•Ïùò ÏãúÍ∞Ñ', textGro, setTextGro); }}
      function handleKeyDownFree(e){ if (e.key==='Enter'&& !e.shiftKey){ e.preventDefault(); addTodo('ÏûêÏú†Ïùò ÏãúÍ∞Ñ', textFree, setTextFree); }}

      function toggleState(i) {
        if (editMode) return;
        const upd = items.map((it, idx) =>
          idx === i && it.type === 'todo' ? { ...it, state: (it.state + 1) % bulletStates.length } : it
        );
        database.ref('todos/' + dateKey).set(upd);
      }
      function deleteItem(i) {
        const filt = items.filter((_, idx) => idx !== i);
        database.ref('todos/' + dateKey).set(filt);
      }
      function editItem(i) {
        const it = items[i];
        if (!it) return;
        const nt = prompt('Edit text:', it.text);
        if (nt != null && nt.trim()) {
          const copy = [...items];
          copy[i].text = nt.trim();
          database.ref('todos/' + dateKey).set(copy);
        }
      }

      function handleKeyDownNote(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          database.ref('notes/' + dateKey).set(noteText.trim());
          setNotesEditMode(false);
        }
      }
      function handleCurrentDateColorChange(e) {
        database.ref('dateColors/' + dateKey).set(e.target.value);
      }

      function handleDragStart(e,i){ if(!editMode) return; setDraggedItem(i); e.currentTarget.style.opacity='0.4'; }
      function handleDragEnd(e){ if(!editMode) return; e.currentTarget.style.opacity='1'; setDraggedItem(null); setDraggedOverItem(null); }
      function handleDragOver(e,i){ if(!editMode) return; e.preventDefault(); setDraggedOverItem(i); }
      function handleDrop(e,i){ if(!editMode) return; e.preventDefault(); const copy=[...items]; const mv=copy.splice(draggedItem,1)[0]; copy.splice(i,0,mv); database.ref('todos/'+dateKey).set(copy); setDraggedItem(null); setDraggedOverItem(null); }

      async function exportAsImage(){ const container=document.querySelector('.todo-container'); const canvas=await html2canvas(container,{backgroundColor:'#fff'}); canvas.toBlob(async blob=>{ try{ await navigator.clipboard.write([ new ClipboardItem({'image/png':blob}) ]); alert('ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Ïù¥ÎØ∏ÏßÄÎ•º Î≥µÏÇ¨ÌñàÏñ¥.'); }catch{ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`todo-${dateKey}.png`; a.click(); URL.revokeObjectURL(url); alert('Ïù¥ÎØ∏ÏßÄÎ•º Îã§Ïö¥Î°úÎìúÌñàÏñ¥.'); }}); }

      const daysInMonth=new Date(selectedDate.getFullYear(),selectedDate.getMonth()+1,0).getDate();
      const firstDay=new Date(selectedDate.getFullYear(),selectedDate.getMonth(),1).getDay();
      const hasTodos=d=>{ const k=d.toISOString().split('T')[0]; return allTodos[k]&&allTodos[k].length>0; };

      return (
        <div style={{display:'flex',minHeight:'100vh'}}>
          <button onClick={()=>setShowSidebar(v=>!v)} className="mobile-toggle">{showSidebar?'‚Üê':'‚Üí'}</button>

          <div className={`sidebar ${showSidebar?'':'hidden'}`}>...</div>

          <div className="main" style={{flex:1,padding:'1rem',marginLeft: showSidebar?'16rem':'0', transition:'margin-left 0.3s'}}>
            <div className="todo-container">...
              <div style={{marginTop:'1rem'}}>
                {categories.map((cat, idx) => (
                  <div key={cat} style={{marginBottom:'1rem'}}>
                    <div style={{fontWeight:'600',marginBottom:'0.5rem'}}>{cat}</div>
                    {tasksByCategory[idx].map(item => (
                      <div key={item.index} draggable={editMode} onDragStart={e=>handleDragStart(e,item.index)} onDragOver={e=>handleDragOver(e,item.index)} onDrop={e=>handleDrop(e,item.index)} onDragEnd={handleDragEnd} style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.25rem'}}>
                        <span onClick={()=>toggleState(item.index)} style={{color:accentColor,cursor:'pointer',fontFamily:'monospace'}}>{bulletStates[item.state]}</span>
                        <span style={{flex:1,whiteSpace:'pre-wrap'}}>{item.text}</span>
                        {editMode&&(
                          <>
                            <button className="edit-delete-btn" onClick={()=>editItem(item.index)}>Edit</button>
                            <button className="edit-delete-btn" onClick={()=>deleteItem(item.index)}>Delete</button>
                          </>
                        )}
                      </div>
                    ))}
                    {idx<categories.length-1&&<hr style={{borderTop:`1px solid ${accentColor}`,margin:'0.75rem 0'}}/>}
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
