<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ùêù : ·¥õ·¥è·¥Ö·¥è</title>
  <link rel="icon" href="./favi.ico" type="image/x-icon" />
  <style>
    @font-face {
      font-family: 'HJSS';
      src: url('./HJSS.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'HJSS', sans-serif;
      background: #f5f5f5;
      box-sizing: border-box;
    }
    *, *::before, *::after {
      box-sizing: inherit;
    }
    .edit-delete-btn {
      font-size: 0.75rem;
      color: #888;
      background: none;
      border: none;
      cursor: pointer;
      margin-left: 0.5rem;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React, ReactDOM, Babel (CDN) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (v9 compat) - Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>

  <!-- html2canvas for image export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script type="text/babel">
    // 1) Firebase ÏÑ§Ï†ï
    const firebaseConfig = {
      apiKey: "AIzaSyAa-8IWlzzPflkV6Iqzunha5TCnMXclTns",
      authDomain: "nagi-todo.firebaseapp.com",
      databaseURL: "https://nagi-todo-default-rtdb.firebaseio.com/",
      projectId: "nagi-todo",
      storageBucket: "nagi-todo.firebasestorage.app",
      messagingSenderId: "923414063910",
      appId: "1:923414063910:web:e09c59bc3cc72a19686fe7"
    };

    // 2) Firebase Ï¥àÍ∏∞Ìôî
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // 3) App Ïª¥Ìè¨ÎÑåÌä∏
    function App() {
      const [text, setText] = React.useState('');
      const [categoryText, setCategoryText] = React.useState('');
      const [selectedDate, setSelectedDate] = React.useState(new Date());
      const [showSidebar, setShowSidebar] = React.useState(true);
      const [allTodos, setAllTodos] = React.useState({});
      const [accentColor, setAccentColor] = React.useState('#888888'); // Í∏∞Î≥∏ ÌöåÏÉâÏúºÎ°ú Î≥ÄÍ≤Ω
      const [draggedItem, setDraggedItem] = React.useState(null);
      const [draggedOverItem, setDraggedOverItem] = React.useState(null);

      // Ìé∏Ïßë Î™®Îìú
      const [editMode, setEditMode] = React.useState(false);

      // ÎÇ†ÏßúÎ≥Ñ ÏÉâÏÉÅ
      const [dateColors, setDateColors] = React.useState({});

      const bulletStates = ['‚òê', '‚òë', '‚òí'];
      const dateKey = selectedDate.toLocaleDateString('en-CA'); // KST Í∏∞Ï§Ä ÎÇ†Ïßú ÌÇ§
      const items = allTodos[dateKey] || [];

      // Îã¨ Í≥ÑÏÇ∞
      const daysInMonth = new Date(
        selectedDate.getFullYear(),
        selectedDate.getMonth() + 1,
        0
      ).getDate();
      const firstDay = new Date(
        selectedDate.getFullYear(),
        selectedDate.getMonth(),
        1
      ).getDay();

      // Firebase Íµ¨ÎèÖ: todos
      React.useEffect(() => {
        const refPath = 'todos/' + dateKey;
        const todosRef = database.ref(refPath);
        const onValueChange = todosRef.on('value', (snapshot) => {
          if (snapshot.exists()) {
            const data = snapshot.val();
            setAllTodos((prev) => ({
              ...prev,
              [dateKey]: data
            }));
          } else {
            setAllTodos((prev) => ({
              ...prev,
              [dateKey]: []
            }));
          }
        });
        return () => todosRef.off('value', onValueChange);
      }, [dateKey]);

      // Firebase Íµ¨ÎèÖ: dateColors
      React.useEffect(() => {
        const colorsRef = database.ref('dateColors');
        const onValueChange = colorsRef.on('value', (snapshot) => {
          if (snapshot.exists()) {
            setDateColors(snapshot.val());
          } else {
            setDateColors({});
          }
        });
        return () => colorsRef.off('value', onValueChange);
      }, []);

      // accentColor (LocalStorage)
      React.useEffect(() => {
        const savedColor = localStorage.getItem('accentColor');
        if (savedColor) setAccentColor(savedColor);
      }, []);
      React.useEffect(() => {
        localStorage.setItem('accentColor', accentColor);
      }, [accentColor]);

      // allTodos ÏóÖÎç∞Ïù¥Ìä∏ + FirebaseÏóê ÎèôÍ∏∞Ìôî
      const updateAllTodos = (updater) => {
        setAllTodos((prev) => {
          const newAll = typeof updater === 'function' ? updater(prev) : updater;
          database.ref('todos/' + dateKey).set(newAll[dateKey] || []);
          return newAll;
        });
      };

      // dateColors ÏóÖÎç∞Ïù¥Ìä∏ + Firebase
      const updateDateColors = (dk, color) => {
        setDateColors((prev) => {
          const newColors = { ...prev, [dk]: color };
          database.ref('dateColors').set(newColors);
          return newColors;
        });
      };

      // Îã¨ Ïù¥Îèô
      function handlePrevMonth() {
        setSelectedDate((prev) => {
          const newDate = new Date(prev.getFullYear(), prev.getMonth() - 1, 1);
          return newDate;
        });
      }
      function handleNextMonth() {
        setSelectedDate((prev) => {
          const newDate = new Date(prev.getFullYear(), prev.getMonth() + 1, 1);
          return newDate;
        });
      }

      // Ìï† Ïùº Ï∂îÍ∞Ä / Íµ¨Î∂ÑÏÑ† Ï∂îÍ∞Ä
      function handleKeyDownTodo(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (text.trim()) {
            updateAllTodos((prev) => ({
              ...prev,
              [dateKey]: [
                ...(prev[dateKey] || []),
                { type: 'todo', text: text.trim(), state: 0 }
              ]
            }));
            setText('');
          }
        }
      }
      function handleKeyDownCategory(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (categoryText.trim()) {
            updateAllTodos((prev) => ({
              ...prev,
              [dateKey]: [
                ...(prev[dateKey] || []),
                { type: 'category', text: categoryText.trim() }
              ]
            }));
            setCategoryText('');
          }
        }
      }
      function addDivider() {
        updateAllTodos((prev) => ({
          ...prev,
          [dateKey]: [...(prev[dateKey] || []), { type: 'divider' }]
        }));
      }

      // Ìï† Ïùº ÏÉÅÌÉú ÌÜ†Í∏Ä
      function toggleState(index) {
        if (editMode) return;
        updateAllTodos((prev) => ({
          ...prev,
          [dateKey]: prev[dateKey].map((item, i) =>
            i === index && item.type === 'todo'
              ? { ...item, state: (item.state + 1) % bulletStates.length }
              : item
          )
        }));
      }

      // ÏÇ≠Ï†ú / Ìé∏Ïßë
      function deleteItem(index) {
        updateAllTodos((prev) => ({
          ...prev,
          [dateKey]: prev[dateKey].filter((_, i) => i !== index)
        }));
      }
      function editItem(index) {
        const item = items[index];
        if (!item) return;
        const newText = prompt('Edit text:', item.text);
        if (newText !== null && newText.trim()) {
          updateAllTodos((prev) => {
            const newItems = [...prev[dateKey]];
            newItems[index] = { ...newItems[index], text: newText.trim() };
            return { ...prev, [dateKey]: newItems };
          });
        }
      }

      // export as image Í∏∞Îä• Ï∂îÍ∞Ä
      async function exportAsImage() {
        try {
          const container = document.getElementById('export-container');
          const canvas = await html2canvas(container);
          canvas.toBlob(async (blob) => {
            try {
              const perm = await navigator.permissions.query({ name: 'clipboard-write' });
              if (perm.state === 'granted' || perm.state === 'prompt') {
                await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                alert('Ìï† Ïùº Î™©Î°ùÏù¥ ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏñ¥.');
              } else {
                alert('ÌÅ¥Î¶ΩÎ≥¥Îìú Ïì∞Í∏∞ Í∂åÌïúÏù¥ ÌïÑÏöîÌï¥.');
              }
            } catch (err) {
              console.error(err);
              alert('ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏñ¥.');
            }
          });
        } catch (error) {
          console.error(error);
          alert('Ïù¥ÎØ∏ÏßÄ ÎÇ¥Î≥¥ÎÇ¥Í∏∞Ïóê Ïã§Ìå®ÌñàÏñ¥.');
        }
      }

      // Ìï¥Îãπ ÎÇ†Ïßú Ìï† Ïùº Ï°¥Ïû¨ Ïó¨Î∂Ä
      const hasTodos = (d) => {
        const key = d.toLocaleDateString('en-CA');
        return allTodos[key] && allTodos[key].length > 0;
      };

      // DnD Ìï®ÏàòÎì§ (Ìé∏Ïßë Î™®ÎìúÏóêÏÑúÎßå ÌôúÏÑ±Ìôî)
      function handleDragStart(e, index) {
        if (!editMode) return;
        setDraggedItem(index);
        e.currentTarget.style.opacity = '0.4';
      }
      function handleDragEnd(e) {
        if (!editMode) return;
        e.currentTarget.style.opacity = '1';
        setDraggedItem(null);
        setDraggedOverItem(null);
      }
      function handleDragOver(e, index) {
        if (!editMode) return;
        e.preventDefault();
        setDraggedOverItem(index);
      }
      function handleDrop(e, index) {
        if (!editMode) return;
        e.preventDefault();
        const itemsCopy = [...items];
        const draggedItemContent = itemsCopy[draggedItem];
        itemsCopy.splice(draggedItem, 1);
        itemsCopy.splice(index, 0, draggedItemContent);
        updateAllTodos((prev) => ({
          ...prev,
          [dateKey]: itemsCopy
        }));
        setDraggedItem(null);
        setDraggedOverItem(null);
      }

      // ÎÇ†ÏßúÎ≥Ñ ÏÉâÏÉÅ
      const currentDateColor = dateColors[dateKey] || '#888888';
      function handleCurrentDateColorChange(e) {
        updateDateColors(dateKey, e.target.value);
      }

      // Render
      return (
        <div style={{ minHeight: '100vh', display: 'flex' }}>
          {/* Î™®Î∞îÏùº ÏÇ¨Ïù¥ÎìúÎ∞î ÌÜ†Í∏Ä Î≤ÑÌäº */}
          <button
            onClick={() => setShowSidebar(!showSidebar)}
            style={{
              position: 'fixed',
              left: '1rem',
              top: '1rem',
              zIndex: 10,
              background: '#fff',
              padding: '0.5rem',
              borderRadius: '9999px',
              boxShadow: '0 2px 5px rgba(0,0,0,0.1)',
              cursor: 'pointer'
            }}
            className="md:hidden"
          >
            {showSidebar ? '‚Üê' : '‚Üí'}
          </button>

          {/* ÏÇ¨Ïù¥ÎìúÎ∞î */}
          <div
            style={{
              position: 'fixed',
              left: 0,
              top: 0,
              bottom: 0,
              width: '16rem',
              background: '#fff',
              boxShadow: '0 2px 5px rgba(0,0,0,0.1)',
              zIndex: 20,
              overflow: 'visible',
              transform: showSidebar ? 'translateX(0)' : 'translateX(-100%)',
              transition: 'transform 0.3s ease-in-out'
            }}
            className="md:translate-x-0"
          >
            <div style={{ padding: '1rem' }}>
              {/* ÎÖÑ/Ïõî */}
              <h2
                style={{
                  fontWeight: 'bold',
                  whiteSpace: 'pre-line',
                  textAlign: 'center',
                  marginBottom: '1rem'
                }}
              >
                {selectedDate.toLocaleString('en-US', { year: 'numeric' })}
                {'\n'}
                {selectedDate.toLocaleString('en-US', { month: 'long' })}
              </h2>

              {/* Ï†ÑÏ≤¥ accentColor (Í∏∞Î≥∏ ÌöåÏÉâ) */}
              <div style={{ display: 'flex', justifyContent: 'center', marginBottom: '1rem' }}>
                <input
                  type="color"
                  value={accentColor}
                  onChange={(e) => setAccentColor(e.target.value)}
                  style={{
                    width: '1.5rem',
                    height: '1.5rem',
                    borderRadius: '9999px',
                    cursor: 'pointer'
                  }}
                />
              </div>

              {/* Îã¨Î†• (ÏöîÏùº Ìó§Îçî) */}
              <div
                style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(7, 1fr)',
                  gap: '0.25rem',
                  fontSize: '0.875rem'
                }}
              >
                {['S','M','T','W','T','F','S'].map((d) => (
                  <div key={d} style={{ textAlign: 'center', fontWeight: '500', color: '#666' }}>
                    {d}
                  </div>
                ))}
                {/* Ï≤´ Ï£º Í≥µÎ∞± Ï±ÑÏö∞Í∏∞ */}
                {Array(firstDay).fill(null).map((_, i) => <div key={`empty-${i}`} />)}
                {Array.from({ length: daysInMonth }, (_, i) => {
                  const dateObj = new Date(
                    selectedDate.getFullYear(),
                    selectedDate.getMonth(),
                    i + 1
                  );
                  const isToday = dateObj.toDateString() === new Date().toDateString();
                  const dKey = dateObj.toLocaleDateString('en-CA');
                  const isSelected = dKey === dateKey;
                  const hasItemsVar = hasTodos(dateObj);

                  const dateCircleColor = dateColors[dKey] || accentColor;

                  return (
                    <button
                      key={i}
                      onClick={() => { setSelectedDate(dateObj); if (window.innerWidth < 768) setShowSidebar(false); }}
                      style={{
                        width: '1.8rem',
                        height: '1.8rem',
                        margin: '0 auto',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        border: isToday && !isSelected ? '1px solid #ccc' : 'none',
                        backgroundColor: isSelected ? dateCircleColor : 'transparent',
                        color: isSelected ? '#fff' : '#000',
                        borderRadius: '9999px',
                        transition: 'background-color 0.2s',
                        position: 'relative',
                        cursor: 'pointer'
                      }}
                    >
                      <span>{i + 1}</span>
                      {hasItemsVar && (
                        <span style={{ fontSize: '0.75rem', color: isSelected ? '#fff' : dateCircleColor, position: 'absolute', bottom: '-0.3rem' }}>‚Ä¢</span>
                      )}
                    </button>
                  );
                })}
              </div>

              {/* Ïù¥Ï†Ñ/Îã§Ïùå Îã¨ Î≤ÑÌäº */}
              <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '1rem' }}>
                <button onClick={handlePrevMonth} style={{ background: '#f0f0f0', border: 'none', padding: '0.25rem 0.5rem', cursor: 'pointer', borderRadius: '0.25rem' }}>‚Üê</button>
                <button onClick={handleNextMonth} style={{ background: '#f0f0f0', border: 'none', padding: '0.25rem 0.5rem', cursor: 'pointer', borderRadius: '0.25rem' }}>‚Üí</button>
              </div>
            </div>
          </div>

          {/* Î©îÏù∏ ÏòÅÏó≠ */}
          <div style={{ flex: 1, padding: '1rem', transition: 'margin-left 0.3s', marginLeft: showSidebar ? '16rem' : '0' }}>
            <div id="export-container" style={{ maxWidth: '42rem', margin: '0 auto', background: '#fff', borderRadius: '0.5rem', boxShadow: '0 2px 5px rgba(0,0,0,0.1)', padding: '1.5rem' }}>
              <h2 style={{ fontSize: '1.25rem', fontWeight: 'bold', marginBottom: '1rem' }}>
                {selectedDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
              </h2>

              {/* Ïù¥ ÎÇ†Ïßú Ï†ÑÏö© ÏÉâÏÉÅ (Optional) */}
              <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '1rem' }}>
                <span style={{ fontSize: '0.9rem' }}>This date's colorÔºö</span>
                <input
                  type="color"
                  value={dateColors[dateKey] || '#888888'}
                  onChange={handleCurrentDateColorChange}
                  style={{ width: '1.5rem', height: '1.5rem', borderRadius: '9999px', cursor: 'pointer' }}
                />
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: 'auto 1fr', columnGap: '0.5rem', rowGap: '0.75rem' }}>
                <textarea
                  value={text}
                  onChange={(e) => setText(e.target.value)}
                  onKeyDown={handleKeyDownTodo}
                  placeholder="Add a task (Enter to save, Shift+Enter for newline)"
                  rows={3}
                  style={{ gridColumn: '1 / 3', border: '1px solid #ccc', padding: '0.5rem', borderRadius: '0.25rem', resize: 'vertical' }}
                />

                <button onClick={addDivider} style={{ padding: '0.5rem 0.75rem', fontSize: '0.875rem', background: '#f0f0f0', border: 'none', borderRadius: '0.25rem', cursor: 'pointer' }}>Add Divider</button>
                <input
                  type="text"
                  value={categoryText}
                  onChange={(e) => setCategoryText(e.target.value)}
                  onKeyDown={handleKeyDownCategory}
                  placeholder="Add category..."
                  style={{ border: '1px solid #ccc', padding: '0.25rem', borderRadius: '0.25rem', fontSize: '0.875rem' }}
                />
              </div>

              <div style={{ marginTop: '1rem', display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                {items.map((item, index) => {
                  const dndProps = editMode ? { draggable: true, onDragStart: (e) => handleDragStart(e, index), onDragEnd: handleDragEnd, onDragOver: (e) => handleDragOver(e, index), onDrop: (e) => handleDrop(e, index) } : {};

                  if (item.type === 'divider') {
                    return (
                      <div key={index} style={{ position: 'relative', borderTop: editMode && draggedOverItem === index ? `2px solid ${accentColor}` : 'none', margin: '0.5rem 0' }} {...dndProps}>
                        <hr style={{ borderTop: `1px solid ${accentColor}`, margin: '0.5rem 0' }} />
                        {editMode && (<div style={{ textAlign: 'right' }}><button className="edit-delete-btn" onClick={() => deleteItem(index)}>Delete</button></div>)}
                      </div>
                    );
                  }

                  if (item.type === 'category') {
                    return (
                      <div key={index} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', cursor: editMode ? 'move' : 'default', borderTop: editMode && draggedOverItem === index ? `2px solid ${accentColor}` : 'none' }} {...dndProps}>
                        <div style={{ fontWeight: '600', color: '#555' }}>{item.text}</div>
                        {editMode && (<><button className="edit-delete-btn" onClick={() => editItem(index)}>Edit</button><button className="edit-delete-btn" onClick={() => deleteItem(index)}>Delete</button></>)}
                      </div>
                    );
                  }

                  return (
                    <div key={index} style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', padding: '0.5rem', borderRadius: '0.25rem', cursor: editMode ? 'move' : 'default', background: '#fafafa', borderTop: editMode && draggedOverItem === index ? `2px solid ${accentColor}` : 'none' }} {...dndProps}>
                      <span onClick={(e) => { if (!editMode) { e.stopPropagation(); toggleState(index); } }} style={{ color: accentColor, fontFamily: 'monospace', fontSize: '1.25rem', cursor: editMode ? 'default' : 'pointer' }}>{bulletStates[item.state]}</span>
                      <span style={{ flex: 1, whiteSpace: 'pre-wrap' }}>{item.text}</span>
                      {editMode && (<><button className="edit-delete-btn" onClick={() => editItem(index)}>Edit</button><button className="edit-delete-btn" onClick={() => deleteItem(index)}>Delete</button></>)}
                    </div>
                  );
                })}
              </div>

              {/* Export and Edit buttons */}
              <div style={{ display: 'flex', gap: '0.5rem', marginTop: '1rem' }}>
                {items.length > 0 && (<button onClick={exportAsImage} style={{ flex: 1, padding: '0.5rem', fontSize: '0.875rem', background: accentColor, color: '#fff', border: 'none', borderRadius: '0.25rem', cursor: 'pointer' }}>Export as Image</button>)}
                <button onClick={() => setEditMode((prev) => !prev)} style={{ flex: items.length > 0 ? 'unset' : 1, padding: '0.5rem', fontSize: '0.875rem', background: editMode ? '#dddddd' : '#f0f0f0', border: 'none', borderRadius: '0.25rem', cursor: 'pointer' }}>{editMode ? 'Done' : 'Edit'}</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // 4) ReactDOMÏúºÎ°ú Î†åÎçîÎßÅ
    const rootElement = document.getElementById('root');
    const root = ReactDOM.createRoot(rootElement);
    root.render(<App />);
  </script>
</body>
</html>
