<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ùêù : ·¥õ·¥è·¥Ö·¥è</title>
  <link rel="icon" href="./favi.ico" type="image/x-icon" />
  <style>
    @font-face {
      font-family: 'HJSS';
      src: url('./HJSS.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'HJSS', sans-serif;
      background: #f5f5f5;
      box-sizing: border-box;
    }
    *, *::before, *::after {
      box-sizing: inherit;
    }
    .edit-delete-btn {
      font-size: 0.75rem;
      color: #888;
      background: none;
      border: none;
      cursor: pointer;
      margin-left: 0.5rem;
    }
  </style>

  <!-- html2canvas for Export as Image -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <!-- React, ReactDOM, Babel (CDN) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (v9 compat) - Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>

  <script type="text/babel">
    // 1) KST Í∏∞Ï§Ä ÎÇ†Ïßú Í∞ÄÏ†∏Ïò§Í∏∞
    const getKSTDate = () => new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));

    // 2) Firebase ÏÑ§Ï†ï
    const firebaseConfig = {
      apiKey: "AIzaSyAa-8IWlzzPflkV6Iqzunha5TCnMXclTns",
      authDomain: "nagi-todo.firebaseapp.com",
      databaseURL: "https://nagi-todo-default-rtdb.firebaseio.com/",
      projectId: "nagi-todo",
      storageBucket: "nagi-todo.firebasestorage.app",
      messagingSenderId: "923414063910",
      appId: "1:923414063910:web:e09c59bc3cc72a19686fe7"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    function App() {
      // KST Í∏∞Ï§Ä Ïò§ÎäòÎ°ú Ï¥àÍ∏∞Ìôî
      const [selectedDate, setSelectedDate] = React.useState(getKSTDate());
      const [text, setText] = React.useState('');
      const [categoryText, setCategoryText] = React.useState('');
      const [showSidebar, setShowSidebar] = React.useState(true);
      const [allTodos, setAllTodos] = React.useState({});
      // Í∏∞Î≥∏ Ïª¨Îü¨Î•º ÌöåÏÉâ(#888888)ÏúºÎ°ú
      const [accentColor, setAccentColor] = React.useState('#888888');
      const [dateColors, setDateColors] = React.useState({});
      const [editMode, setEditMode] = React.useState(false);
      const [draggedItem, setDraggedItem] = React.useState(null);
      const [draggedOverItem, setDraggedOverItem] = React.useState(null);

      const bulletStates = ['‚òê', '‚òë', '‚òí'];
      const dateKey = selectedDate.toISOString().split('T')[0];
      const items = allTodos[dateKey] || [];

      // Firebase Íµ¨ÎèÖ: todos
      React.useEffect(() => {
        const refPath = 'todos/' + dateKey;
        const todosRef = database.ref(refPath);
        const onValueChange = todosRef.on('value', snapshot => {
          if (snapshot.exists()) {
            setAllTodos(prev => ({ ...prev, [dateKey]: snapshot.val() }));
          } else {
            setAllTodos(prev => ({ ...prev, [dateKey]: [] }));
          }
        });
        return () => todosRef.off('value', onValueChange);
      }, [dateKey]);

      // Firebase Íµ¨ÎèÖ: dateColors
      React.useEffect(() => {
        const colorsRef = database.ref('dateColors');
        const onValueChange = colorsRef.on('value', snapshot => {
          setDateColors(snapshot.exists() ? snapshot.val() : {});
        });
        return () => colorsRef.off('value', onValueChange);
      }, []);

      // accentColor LocalStorage ÎèôÍ∏∞Ìôî
      React.useEffect(() => {
        const saved = localStorage.getItem('accentColor');
        if (saved) setAccentColor(saved);
      }, []);
      React.useEffect(() => {
        localStorage.setItem('accentColor', accentColor);
      }, [accentColor]);

      // allTodos ÏóÖÎç∞Ïù¥Ìä∏ + Firebase ÎèôÍ∏∞Ìôî
      const updateAllTodos = updater => {
        setAllTodos(prev => {
          const next = typeof updater === 'function' ? updater(prev) : updater;
          database.ref('todos/' + dateKey).set(next[dateKey] || []);
          return next;
        });
      };
      const updateDateColors = (dk, color) => {
        setDateColors(prev => {
          const next = { ...prev, [dk]: color };
          database.ref('dateColors').set(next);
          return next;
        });
      };

      // Îã¨Î†• Í≥ÑÏÇ∞
      const daysInMonth = new Date(
        selectedDate.getFullYear(),
        selectedDate.getMonth() + 1,
        0
      ).getDate();
      const firstDay = new Date(
        selectedDate.getFullYear(),
        selectedDate.getMonth(),
        1
      ).getDay();

      // ÌÇ§ ÏûÖÎ†• Ìï∏Îì§Îü¨
      const handleKeyDownTodo = e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (text.trim()) {
            updateAllTodos(prev => ({
              ...prev,
              [dateKey]: [...(prev[dateKey] || []), { type: 'todo', text: text.trim(), state: 0 }]
            }));
            setText('');
          }
        }
      };
      const handleKeyDownCategory = e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (categoryText.trim()) {
            updateAllTodos(prev => ({
              ...prev,
              [dateKey]: [...(prev[dateKey] || []), { type: 'category', text: categoryText.trim() }]
            }));
            setCategoryText('');
          }
        }
      };
      const addDivider = () => {
        updateAllTodos(prev => ({
          ...prev,
          [dateKey]: [...(prev[dateKey] || []), { type: 'divider' }]
        }));
      };

      // ÏÉÅÌÉú ÌÜ†Í∏Ä
      const toggleState = index => {
        if (editMode) return;
        updateAllTodos(prev => ({
          ...prev,
          [dateKey]: prev[dateKey].map((item, i) =>
            i === index && item.type === 'todo'
              ? { ...item, state: (item.state + 1) % bulletStates.length }
              : item
          )
        }));
      };

      // ÏÇ≠Ï†ú/Ìé∏Ïßë
      const deleteItem = index => {
        updateAllTodos(prev => ({
          ...prev,
          [dateKey]: prev[dateKey].filter((_, i) => i !== index)
        }));
      };
      const editItem = index => {
        const item = items[index];
        if (!item) return;
        const newText = prompt('Edit text:', item.text);
        if (newText !== null && newText.trim()) {
          updateAllTodos(prev => {
            const copy = [...prev[dateKey]];
            copy[index] = { ...copy[index], text: newText.trim() };
            return { ...prev, [dateKey]: copy };
          });
        }
      };

      // Drag & Drop (Ìé∏Ïßë Î™®Îìú)
      const handleDragStart = (e, i) => {
        if (!editMode) return;
        setDraggedItem(i);
        e.currentTarget.style.opacity = '0.4';
      };
      const handleDragEnd = e => {
        if (!editMode) return;
        e.currentTarget.style.opacity = '1';
        setDraggedItem(null);
        setDraggedOverItem(null);
      };
      const handleDragOver = (e, i) => {
        if (!editMode) return;
        e.preventDefault();
        setDraggedOverItem(i);
      };
      const handleDrop = (e, i) => {
        if (!editMode) return;
        e.preventDefault();
        const copy = [...items];
        const moved = copy.splice(draggedItem, 1)[0];
        copy.splice(i, 0, moved);
        updateAllTodos(prev => ({ ...prev, [dateKey]: copy }));
        setDraggedItem(null);
        setDraggedOverItem(null);
      };

      // Export as Image
      const exportToImage = async () => {
        const container = document.getElementById('root').querySelector('div[style*="maxWidth"]');
        const canvas = await html2canvas(container, { backgroundColor: '#ffffff' });
        canvas.toBlob(async blob => {
          try {
            await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
          } catch {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `todos-${dateKey}.png`;
            link.click();
            URL.revokeObjectURL(url);
          }
        });
      };

      // ÌòÑÏû¨ ÎÇ†Ïßú ÎπÑÍµê (KST)
      const todayString = getKSTDate().toDateString();
      const hasTodos = d => {
        const key = d.toISOString().split('T')[0];
        return allTodos[key] && allTodos[key].length > 0;
      };

      // Îã¨ Ïù¥Îèô & Today
      const handlePrevMonth = () => {
        setSelectedDate(prev => new Date(prev.getFullYear(), prev.getMonth() - 1, 1));
      };
      const handleNextMonth = () => {
        setSelectedDate(prev => new Date(prev.getFullYear(), prev.getMonth() + 1, 1));
      };
      const handleToday = () => {
        const kst = getKSTDate();
        setSelectedDate(kst);
      };

      // Î†åÎçîÎßÅ
      return (
        <div style={{ minHeight: '100vh', display: 'flex' }}>
          <button
            onClick={() => setShowSidebar(!showSidebar)}
            style={{
              position: 'fixed',
              left: '1rem',
              top: '1rem',
              zIndex: 10,
              background: '#fff',
              padding: '0.5rem',
              borderRadius: '9999px',
              boxShadow: '0 2px 5px rgba(0,0,0,0.1)',
              cursor: 'pointer'
            }}
            className="md:hidden"
          >
            {showSidebar ? '‚Üê' : '‚Üí'}
          </button>

          <div
            style={{
              position: 'fixed',
              left: 0,
              top: 0,
              bottom: 0,
              width: '16rem',
              background: '#fff',
              boxShadow: '0 2px 5px rgba(0,0,0,0.1)',
              zIndex: 20,
              overflow: 'visible',
              transform: showSidebar ? 'translateX(0)' : 'translateX(-100%)',
              transition: 'transform 0.3s ease-in-out'
            }}
            className="md:translate-x-0"
          >
            <div style={{ padding: '1rem' }}>
              <h2
                style={{
                  fontWeight: 'bold',
                  whiteSpace: 'pre-line',
                  textAlign: 'center',
                  marginBottom: '1rem'
                }}
              >
                {selectedDate.toLocaleString('en-US', { year: 'numeric' })}
                {'\n'}
                {selectedDate.toLocaleString('en-US', { month: 'long' })}
              </h2>

              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1rem' }}>
                <button onClick={handlePrevMonth} style={{ background: '#f0f0f0', border: 'none', padding: '0.25rem', borderRadius: '0.25rem', cursor: 'pointer' }}>‚Üê</button>
                <button onClick={handleToday} style={{ background: '#f0f0f0', border: 'none', padding: '0.25rem', borderRadius: '0.25rem', cursor: 'pointer' }}>Today</button>
                <button onClick={handleNextMonth} style={{ background: '#f0f0f0', border: 'none', padding: '0.25rem', borderRadius: '0.25rem', cursor: 'pointer' }}>‚Üí</button>
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '0.25rem', fontSize: '0.875rem' }}>
                {['S','M','T','W','T','F','S'].map(d => <div key={d} style={{ textAlign: 'center', fontWeight: '500', color: '#666' }}>{d}</div>)}
                {Array(firstDay).fill(null).map((_, i) => <div key={`e${i}`} />)}
                {Array.from({ length: daysInMonth }, (_, i) => {
                  const dateObj = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), i+1);
                  const dKey = dateObj.toISOString().split('T')[0];
                  const isSelected = dKey === dateKey;
                  const hasMark = hasTodos(dateObj);
                  return (
                    <button
                      key={i}
                      onClick={() => { setSelectedDate(dateObj); if (window.innerWidth<768) setShowSidebar(false); }}
                      style={{
                        width:'1.8rem',height:'1.8rem',margin:'0 auto',display:'flex',alignItems:'center',justifyContent:'center',
                        backgroundColor:isSelected? (dateColors[dKey]||accentColor):'transparent',
                        color:isSelected?'#fff':'#000',borderRadius:'9999px',position:'relative',cursor:'pointer'
                      }}
                    >
                      <span>{i+1}</span>
                      {hasMark&&<span style={{fontSize:'0.75rem',color:isSelected?'#fff':(dateColors[dKey]||accentColor),position:'absolute',bottom:'-0.3rem'}}>‚Ä¢</span>}
                    </button>
                  );
                })}
              </div>
            </div>
          </div>

          <div style={{ flex:1,padding:'1rem',marginLeft: showSidebar?'16rem':'0',transition:'margin-left 0.3s' }}>
            <div style={{ maxWidth:'42rem',margin:'0 auto',background:'#fff',borderRadius:'0.5rem',boxShadow:'0 2px 5px rgba(0,0,0,0.1)',padding:'1.5rem' }}>
              <h2 style={{ fontSize:'1.25rem',fontWeight:'bold',marginBottom:'1rem' }}>
                {selectedDate.toLocaleDateString('en-US',{ weekday:'long', year:'numeric', month:'long', day:'numeric' })}
              </h2>

              <div style={{ display:'grid',gridTemplateColumns:'auto 1fr',columnGap:'0.5rem',rowGap:'0.75rem' }}>
                <textarea
                  value={text}
                  onChange={e=>setText(e.target.value)}
                  onKeyDown={handleKeyDownTodo}
                  placeholder="Add a task (Enter to save, Shift+Enter for newline)"
                  rows={3}
                  style={{ gridColumn:'1/3',border:'1px solid #ccc',padding:'0.5rem',borderRadius:'0.25rem',resize:'vertical' }}
                />
                <button onClick={addDivider} style={{ padding:'0.5rem 0.75rem',fontSize:'0.875rem',background:'#f0f0f0',border:'none',borderRadius:'0.25rem',cursor:'pointer' }}>Add Divider</button>
                <input
                  type="text"
                  value={categoryText}
                  onChange={e=>setCategoryText(e.target.value)}
                  onKeyDown={handleKeyDownCategory}
                  placeholder="Add category..."
                  style={{ border:'1px solid #ccc',padding:'0.25rem',borderRadius:'0.25rem',fontSize:'0.875rem' }}
                />
              </div>

              <div style={{ marginTop:'1rem',display:'flex',flexDirection:'column',gap:'0.5rem' }}>
                {items.map((item, idx) => {
                  const dnd = editMode ? {
                    draggable:true,
                    onDragStart:e=>handleDragStart(e,idx),
                    onDragEnd:handleDragEnd,
                    onDragOver:e=>handleDragOver(e,idx),
                    onDrop:e=>handleDrop(e,idx)
                  }:{};
                  if(item.type==='divider'){
                    return <div key={idx} style={{ position:'relative',borderTop: editMode&&draggedOverItem===idx?`2px solid ${accentColor}`:'none',margin:'0.5rem 0' }} {...dnd}>
                      <hr style={{ borderTop:`1px solid ${accentColor}`,margin:'0.5rem 0' }} />
                      {editMode&&<div style={{ textAlign:'right' }}><button className="edit-delete-btn" onClick={()=>deleteItem(idx)}>Delete</button></div>}
                    </div>;
                  }
                  if(item.type==='category'){
                    return <div key={idx} style={{ display:'flex',justifyContent:'space-between',alignItems:'center',cursor:editMode?'move':'default',borderTop:editMode&&draggedOverItem===idx?`2px solid ${accentColor}`:'none' }} {...dnd}>
                      <div style={{ fontWeight:'600',color:'#555' }}>{item.text}</div>
                      {editMode&&<>
                        <button className="edit-delete-btn" onClick={()=>editItem(idx)}>Edit</button>
                        <button className="edit-delete-btn" onClick={()=>deleteItem(idx)}>Delete</button>
                      </>}
                    </div>;
                  }
                  return <div key={idx} style={{ display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.5rem',borderRadius:'0.25rem',cursor:editMode?'move':'default',background:'#fafafa',borderTop:editMode&&draggedOverItem===idx?`2px solid ${accentColor}`:'none' }} {...dnd}>
                    <span onClick={e=>{if(!editMode){e.stopPropagation();toggleState(idx);}}} style={{ color:accentColor,fontFamily:'monospace',fontSize:'1.25rem',cursor:editMode?'default':'pointer' }}>{bulletStates[item.state]}</span>
                    <span style={{ flex:1,whiteSpace:'pre-wrap' }}>{item.text}</span>
                    {editMode&&<>
                      <button className="edit-delete-btn" onClick={()=>editItem(idx)}>Edit</button>
                      <button className="edit-delete-btn" onClick={()=>deleteItem(idx)}>Delete</button>
                    </>}
                  </div>;
                })}
              </div>

              <div style={{ display:'flex',gap:'0.5rem',marginTop:'1rem' }}>
                {items.length>0&&<button onClick={exportToImage} style={{ flex:1,padding:'0.5rem',fontSize:'0.875rem',background:accentColor,color:'#fff',border:'none',borderRadius:'0.25rem',cursor:'pointer' }}>Export as Image</button>}
                <button onClick={()=>setEditMode(prev=>!prev)} style={{ flex: items.length>0?'unset':1,padding:'0.5rem',fontSize:'0.875rem',background: editMode?'#dddddd':'#f0f0f0',border:'none',borderRadius:'0.25rem',cursor:'pointer' }}>{editMode?'Done':'Edit'}</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
