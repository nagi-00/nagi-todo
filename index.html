<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ùêù : ·¥õ·¥è·¥Ö·¥è</title>
  <link rel="icon" href="./favi.ico" type="image/x-icon" />
  <style>
    @font-face {
      font-family: 'HJSS';
      src: url('./HJSS.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    body {
      margin: 0; padding: 0;
      font-family: 'HJSS', sans-serif;
      background: #f5f5f5;
      box-sizing: border-box;
    }
    *, *::before, *::after { box-sizing: inherit; }
    .edit-delete-btn {
      font-size: 0.75rem; color: #888;
      background: none; border: none;
      cursor: pointer; margin-left: 0.5rem;
    }
    /* color picker ÌÖçÏä§Ìä∏ Ïà®Í∏∞Í∏∞ */
    input[type=color] {
      -webkit-appearance: none; appearance: none;
      border: none; padding: 0;
      width: 1.5rem; height: 1.5rem;
      cursor: pointer;
    }
    input[type=color]::-webkit-color-swatch-wrapper { padding: 0; }
    input[type=color]::-webkit-color-swatch { border: none; }
    input[type=color]::-webkit-color-swatch-text { display: none; }
    input[type=color]::-moz-color-swatch,
    input[type=color]::-moz-color-swatch-wrapper { border: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React / Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>

  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script type="text/babel">
    const firebaseConfig = {
      apiKey: "...", authDomain: "...",
      databaseURL: "...", projectId: "...",
      storageBucket: "...", messagingSenderId: "...",
      appId: "..."
    };
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // KST ÏûêÏ†ï Î∞òÌôò
    function getSeoulDate() {
      const now = Date.now();
      const utc = now + new Date().getTimezoneOffset() * 60000;
      const kst = new Date(utc + 9 * 60 * 60000);
      kst.setHours(0,0,0,0);
      return kst;
    }

    function App() {
      const [selectedDate, setSelectedDate] = React.useState(getSeoulDate());
      const [allTodos, setAllTodos]             = React.useState({});
      const [dateColors, setDateColors]         = React.useState({});
      const [notes, setNotes]                   = React.useState({});
      const [noteText, setNoteText]             = React.useState('');
      const [showNotesList, setShowNotesList]   = React.useState(false);
      const [notesEditMode, setNotesEditMode]   = React.useState(false);
      const [accentColor, setAccentColor]       = React.useState('#888888');
      const [editMode, setEditMode]             = React.useState(false);
      const [draggedItem, setDraggedItem]       = React.useState(null);
      const [draggedOverItem, setDraggedOverItem] = React.useState(null);

      const [textNec, setTextNec]   = React.useState('');
      const [textGro, setTextGro]   = React.useState('');
      const [textFree, setTextFree] = React.useState('');

      const bulletStates = ['‚òê','‚òë','‚òí'];
      const categories   = ['ÌïÑÏó∞Ïùò ÏãúÍ∞Ñ','ÏÑ±Ïû•Ïùò ÏãúÍ∞Ñ','ÏûêÏú†Ïùò ÏãúÍ∞Ñ'];
      const dateKey      = selectedDate.toISOString().split('T')[0];
      const items        = allTodos[dateKey] || [];

      // Í∑∏Î£πÌôîÎêú Î∞∞Ïó¥
      const tasksByCategory = categories.map(cat =>
        items.map((it,i)=> it.type==='todo'&&it.category===cat?{...it,index:i}:null)
             .filter(x=>x)
      );

      // Íµ¨ÎèÖ: todos
      React.useEffect(()=>{
        const ref = database.ref('todos/'+dateKey);
        const h   = ref.on('value',s=>setAllTodos(prev=>({
          ...prev, [dateKey]: s.val()||[]
        })));
        return ()=>ref.off('value',h);
      },[dateKey]);

      // Íµ¨ÎèÖ: Ïª¨Îü¨
      React.useEffect(()=>{
        const ref = database.ref('dateColors');
        const h   = ref.on('value',s=>setDateColors(s.val()||{}));
        return ()=>ref.off('value',h);
      },[]);

      // Íµ¨ÎèÖ: ÎÖ∏Ìä∏(Ïò§Îäò)
      React.useEffect(()=>{
        setNotesEditMode(false);
        const ref = database.ref('notes/'+dateKey);
        const h   = ref.on('value',s=>setNoteText(s.val()||''));
        return ()=>ref.off('value',h);
      },[dateKey]);

      // Íµ¨ÎèÖ: Ï†ÑÏ≤¥ ÎÖ∏Ìä∏
      React.useEffect(()=>{
        const ref = database.ref('notes');
        const h   = ref.on('value',s=>setNotes(s.val()||{}));
        return ()=>ref.off('value',h);
      },[]);

      // accentColor Î°úÏª¨ Ï†ÄÏû•
      React.useEffect(()=>{
        const v = localStorage.getItem('accentColor');
        if(v) setAccentColor(v);
      },[]);
      React.useEffect(()=>{
        localStorage.setItem('accentColor',accentColor);
      },[accentColor]);

      // ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò
      function prevMonth(){setSelectedDate(d=>new Date(d.getFullYear(),d.getMonth()-1,1));}
      function nextMonth(){setSelectedDate(d=>new Date(d.getFullYear(),d.getMonth()+1,1));}
      function goToday(){
        setSelectedDate(getSeoulDate());
        setShowNotesList(false);
      }

      // Ìï† Ïùº Ï∂îÍ∞Ä
      function addTodo(cat,text,setter){
        if(!text.trim()) return;
        database.ref('todos/'+dateKey).set([
          ...items, {type:'todo',category:cat,text:text.trim(),state:0}
        ]);
        setter('');
      }
      function onKeyDownNec(e){ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();addTodo('ÌïÑÏó∞Ïùò ÏãúÍ∞Ñ',textNec,setTextNec);} }
      function onKeyDownGro(e){ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();addTodo('ÏÑ±Ïû•Ïùò ÏãúÍ∞Ñ',textGro,setTextGro);} }
      function onKeyDownFree(e){ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();addTodo('ÏûêÏú†Ïùò ÏãúÍ∞Ñ',textFree,setTextFree);} }

      // ÌÜ†Í∏Ä/ÏÇ≠Ï†ú/Ìé∏Ïßë
      function toggleState(i){
        if(editMode) return;
        const upd = items.map((it,idx)=>
          idx===i&&it.type==='todo'
            ?{...it, state:(it.state+1)%bulletStates.length}
            : it
        );
        database.ref('todos/'+dateKey).set(upd);
      }
      function deleteItem(i){
        const f = items.filter((_,idx)=>idx!==i);
        database.ref('todos/'+dateKey).set(f);
      }
      function editItem(i){
        const it = items[i];
        if(!it) return;
        const nt = prompt('Edit text:',it.text);
        if(nt!=null&&nt.trim()){
          const c=[...items];
          c[i].text=nt.trim();
          database.ref('todos/'+dateKey).set(c);
        }
      }

      // ÎÖ∏Ìä∏ Ï†ÄÏû•/ÏÉâ
      function onKeyDownNote(e){
        if(e.key==='Enter'&&!e.shiftKey){
          e.preventDefault();
          database.ref('notes/'+dateKey).set(noteText.trim());
          setNotesEditMode(false);
        }
      }
      function onColorChange(e){
        database.ref('dateColors/'+dateKey).set(e.target.value);
      }

      // DnD
      function onDragStart(e,i){ if(!editMode)return; setDraggedItem(i); e.currentTarget.style.opacity='0.4'; }
      function onDragEnd(e){ if(!editMode)return; e.currentTarget.style.opacity='1'; setDraggedItem(null); setDraggedOverItem(null); }
      function onDragOver(e,i){ if(!editMode)return; e.preventDefault(); setDraggedOverItem(i); }
      function onDrop(e,i){
        if(!editMode)return;
        e.preventDefault();
        const c=[...items];
        const mv=c.splice(draggedItem,1)[0];
        c.splice(i,0,mv);
        database.ref('todos/'+dateKey).set(c);
        setDraggedItem(null); setDraggedOverItem(null);
      }

      // Export
      async function exportAsImage(){
        const container=document.querySelector('.todo-container');
        const canvas=await html2canvas(container,{backgroundColor:'#fff'});
        canvas.toBlob(async blob=>{
          try{
            await navigator.clipboard.write([new ClipboardItem({'image/png':blob})]);
            alert('ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Ïù¥ÎØ∏ÏßÄÎ•º Î≥µÏÇ¨ÌñàÏñ¥.');
          }catch{
            const url=URL.createObjectURL(blob);
            const a=document.createElement('a');
            a.href=url; a.download=`todo-${dateKey}.png`; a.click();
            URL.revokeObjectURL(url);
            alert('Ïù¥ÎØ∏ÏßÄÎ•º Îã§Ïö¥Î°úÎìúÌñàÏñ¥.');
          }
        });
      }

      // Îã¨Î†•
      const daysInMonth=new Date(selectedDate.getFullYear(),selectedDate.getMonth()+1,0).getDate();
      const firstDay  =new Date(selectedDate.getFullYear(),selectedDate.getMonth(),1).getDay();
      const hasTodosFn=d=>{
        const k=d.toISOString().split('T')[0];
        return allTodos[k]&&allTodos[k].length>0;
      };

      return (
        <div style={{display:'flex',minHeight:'100vh'}}>
          <button onClick={()=>setShowNotesList(v=>!v)} style={{position:'fixed',left:10,top:10,zIndex:10,background:'#fff',padding:8,borderRadius:999,cursor:'pointer'}} className="md:hidden">
            {showNotesList?'‚Üê':'‚Üí'}
          </button>

          <div style={{position:'fixed',left:0,top:0,bottom:0,width:256,background:'#fff',overflow:'auto',transform:showNotesList?'translateX(0)':'translateX(-100%)',transition:'transform .3s',boxShadow:'0 0 10px rgba(0,0,0,.1)',zIndex:20}}>
            <div style={{padding:16}}>
              <h2 style={{textAlign:'center',fontWeight:'bold',whiteSpace:'pre-line',marginBottom:16}}>
                {selectedDate.toLocaleString('en-US',{year:'numeric'})}{'\n'}
                {selectedDate.toLocaleString('en-US',{month:'long'})}
              </h2>
              <div style={{display:'flex',justifyContent:'center',gap:8,margin:'8px 0'}}>
                <button onClick={prevMonth} style={{background:'#fff',border:'none',cursor:'pointer'}}>‚Üê</button>
                <button onClick={goToday}   style={{background:'#fff',border:'none',cursor:'pointer'}}>Today</button>
                <button onClick={nextMonth} style={{background:'#fff',border:'none',cursor:'pointer'}}>‚Üí</button>
              </div>
              <button onClick={()=>setShowNotesList(v=>!v)} style={{width:'100%',padding:8,marginBottom:16,background:'#f0f0f0',border:'none',cursor:'pointer'}}>
                {showNotesList?'Back':'Notes'}
              </button>

              {showNotesList
                ? Object.entries(notes).sort((a,b)=>b[0].localeCompare(a[0])).map(([d,txt])=>(
                    <div key={d} style={{background:'#fff',borderRadius:8,padding:12,marginBottom:8,boxShadow:'0 1px 3px rgba(0,0,0,.1)'}}>
                      <div style={{fontWeight:'600',marginBottom:4}}>
                        {new Date(d).toLocaleString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}
                      </div>
                      <div style={{fontWeight:'bold',whiteSpace:'pre-wrap',color:dateColors[d]||accentColor}}>{txt}</div>
                      <button className="edit-delete-btn" onClick={()=>database.ref('notes/'+d).remove()}>Delete</button>
                    </div>
                  ))
                : <div style={{display:'grid',gridTemplateColumns:'repeat(7,1fr)',gap:4,fontSize:14}}>
                    {['S','M','T','W','T','F','S'].map(d=><div key={d} style={{textAlign:'center',color:'#666'}}>{d}</div>)}
                    {Array(firstDay).fill().map((_,i)=><div key={i}/>)} 
                    {Array.from({length:daysInMonth},(_,i)=>{
                      const dt=new Date(selectedDate.getFullYear(),selectedDate.getMonth(),i+1);
                      const k=dt.toISOString().split('T')[0];
                      const sel=k===dateKey;
                      const col=dateColors[k]||accentColor;
                      return (
                        <button key={i} onClick={()=>{
                          setSelectedDate(dt);
                          setShowNotesList(false);
                        }} style={{
                          width:28,height:28,margin:'0 auto',
                          display:'flex',alignItems:'center',justifyContent:'center',
                          background:sel?col:'transparent',
                          color:sel?'#fff':'#000',
                          border:'none',cursor:'pointer',position:'relative',
                          borderRadius:999
                        }}>
                          {i+1}
                          {hasTodosFn(dt) && <span style={{position:'absolute',bottom:-4,fontSize:10,color:sel?'#fff':col}}>‚Ä¢</span>}
                        </button>
                      );
                    })}
                  </div>
              }
            </div>
          </div>

          <div style={{flex:1,padding:16,marginLeft:showNotesList?256:0,transition:'margin-left .3s'}}>
            <div className="todo-container" style={{maxWidth:672,margin:'0 auto',background:'#fff',borderRadius:8,boxShadow:'0 2px 5px rgba(0,0,0,.1)',padding:24}}>
              <h2 style={{fontSize:20,fontWeight:'bold',marginBottom:16}}>
                {selectedDate.toLocaleString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}
              </h2>

              {/* Notes */}
              <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:16}}>
                {(!notesEditMode && noteText.trim()) 
                  ? <div onDoubleClick={()=>setNotesEditMode(true)} style={{fontWeight:'bold',whiteSpace:'pre-wrap',color:accentColor,cursor:'pointer'}}>{noteText}</div>
                  : <textarea
                      value={noteText}
                      onFocus={()=>setNotesEditMode(true)}
                      onChange={e=>setNoteText(e.target.value)}
                      onKeyDown={onKeyDownNote}
                      placeholder="Notes (Enter Ï†ÄÏû•, Shift+Enter Ï§ÑÎ∞îÍøà)"
                      rows={2}
                      style={{flex:1,border:'1px solid #ccc',padding:8,borderRadius:4,resize:'vertical',fontWeight:'bold',color:accentColor}}
                    />
                }
                <input type="color" value={dateColors[dateKey]||accentColor} onChange={onColorChange}/>
              </div>

              {/* ÏÑ∏ Íµ¨Ìöç ÏûÖÎ†• */}
              <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:8,marginBottom:16}}>
                {[{label:'ÌïÑÏó∞Ïùò ÏãúÍ∞Ñ', state:textNec, onChange:setTextNec, onKey: onKeyDownNec},
                  {label:'ÏÑ±Ïû•Ïùò ÏãúÍ∞Ñ', state:textGro, onChange:setTextGro, onKey: onKeyDownGro},
                  {label:'ÏûêÏú†Ïùò ÏãúÍ∞Ñ', state:textFree, onChange:setTextFree, onKey: onKeyDownFree}]
                .map((cfg,i)=>(
                  <div key={i}>
                    <div style={{fontWeight:'600',marginBottom:4}}>{cfg.label}</div>
                    <textarea
                      value={cfg.state}
                      onChange={e=>cfg.onChange(e.target.value)}
                      onKeyDown={cfg.onKey}
                      placeholder={`${cfg.label} (Enter Ï†ÄÏû•)`}
                      rows={3}
                      style={{width:'100%',border:'1px solid #ccc',padding:8,borderRadius:4,resize:'vertical'}}
                    />
                  </div>
                ))}
              </div>

              {/* Í∑∏Î£πÌôîÎêú Î™©Î°ù */}
              <div style={{marginTop:16}}>
                {categories.map((cat,idx)=>(
                  <div key={cat} style={{marginBottom:24}}>
                    <div style={{fontWeight:'600',marginBottom:8}}>{cat}</div>
                    {tasksByCategory[idx].map(item=>{
                      const dndProps = editMode?{
                        draggable:true,
                        onDragStart:e=>onDragStart(e,item.index),
                        onDragEnd: onDragEnd,
                        onDragOver:e=>onDragOver(e,item.index),
                        onDrop:e=>onDrop(e,item.index)
                      }:{};
                      return (
                        <div key={item.index} {...dndProps} style={{
                          display:'flex',alignItems:'center',gap:8,padding:8,
                          borderRadius:4,background:'#fafafa',marginBottom:4,
                          cursor: editMode?'move':'pointer'
                        }}>
                          <span onClick={()=>toggleState(item.index)}
                            style={{fontFamily:'monospace',fontSize:18,color:accentColor}}>
                            {bulletStates[item.state]}
                          </span>
                          <span style={{flex:1,whiteSpace:'pre-wrap'}}>{item.text}</span>
                          {editMode && (
                            <>
                              <button className="edit-delete-btn" onClick={()=>editItem(item.index)}>Edit</button>
                              <button className="edit-delete-btn" onClick={()=>deleteItem(item.index)}>Delete</button>
                            </>
                          )}
                        </div>
                      );
                    })}
                  </div>
                ))}
              </div>

              {/* Export / Edit */}
              <div style={{display:'flex',gap:8}}>
                {items.length>0 && (
                  <button onClick={exportAsImage} style={{
                    flex:1,padding:12,background:accentColor,color:'#fff',
                    border:'none',borderRadius:4,cursor:'pointer'
                  }}>Export as Image</button>
                )}
                <button onClick={()=>setEditMode(v=>!v)} style={{
                  padding:12,background:editMode?'#ddd':'#f0f0f0',
                  border:'none',borderRadius:4,cursor:'pointer'
                }}>{editMode?'Done':'Edit'}</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
