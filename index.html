<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ùêù : ·¥õ·¥è·¥Ö·¥è</title>
  <link rel="icon" href="./favi.ico" type="image/x-icon" />
  <style>
    @font-face { font-family: 'HJSS'; src: url('./HJSS.ttf') format('truetype'); }
    body { margin: 0; padding: 0; font-family: 'HJSS', sans-serif; background: #f5f5f5; box-sizing: border-box; }
    *, *::before, *::after { box-sizing: inherit; }
    .edit-delete-btn { font-size: 0.75rem; color: #888; background: none; border: none; cursor: pointer; margin-left: 0.5rem; }
    .sidebar-nav { display: flex; justify-content: space-between; padding: 1rem; }
    .sidebar-nav h2 { margin: 0; }
    .sidebar-controls { display: flex; justify-content: center; gap: 0.5rem; margin: 1.5rem 0; }
    .sidebar-controls button { background: #f0f0f0; border: none; padding: 0.5rem; border-radius: 0.25rem; cursor: pointer; }
    .main-container { max-width: 42rem; margin: 0 auto; background: #fff; border-radius: 0.5rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 1.5rem; }
    .note-input { width: 100%; border: 1px solid #ccc; padding: 0.5rem; border-radius: 0.25rem; resize: vertical; margin-bottom: 1rem; }
    .notes-list { display: flex; flex-direction: column; gap: 1rem; }
    .note-card { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.25rem; background: #fafafa; }
    .note-color { width: 1rem; height: 1rem; border-radius: 0.25rem; }
    .back-btn { margin-bottom: 1rem; background: #f0f0f0; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script type="text/babel">
    const firebaseConfig = { /* ...Í∏∞Ï°¥ ÏÑ§Ï†ï... */ };
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    function App() {
      const [text, setText] = React.useState('');
      const [categoryText, setCategoryText] = React.useState('');
      const [selectedDate, setSelectedDate] = React.useState(new Date());
      const [showSidebar, setShowSidebar] = React.useState(true);
      const [allTodos, setAllTodos] = React.useState({});
      const [noteText, setNoteText] = React.useState('');
      const [allNotes, setAllNotes] = React.useState({});
      const [view, setView] = React.useState('todo');
      const [accentColor, setAccentColor] = React.useState('#888888');
      const [dateColors, setDateColors] = React.useState({});
      const [editMode, setEditMode] = React.useState(false);
      const [draggedItem, setDraggedItem] = React.useState(null);
      const [draggedOverItem, setDraggedOverItem] = React.useState(null);

      const bulletStates = ['‚òê','‚òë','‚òí'];
      const dateKey = selectedDate.toLocaleDateString('en-CA');
      const items = allTodos[dateKey] || [];
      
      // Íµ¨ÎèÖ: todos
      React.useEffect(() => {
        const ref = database.ref('todos/'+dateKey);
        const cb = ref.on('value', snap => {
          setAllTodos(prev => ({ ...prev, [dateKey]: snap.exists()?snap.val():[] }));
        });
        return () => ref.off('value', cb);
      }, [dateKey]);
      // Íµ¨ÎèÖ: notes
      React.useEffect(() => {
        const ref = database.ref('notes/'+dateKey);
        const cb = ref.on('value', snap => {
          setNoteText(snap.exists()?snap.val():'');
        });
        return () => ref.off('value', cb);
      }, [dateKey]);
      React.useEffect(() => {
        const ref = database.ref('notes');
        const cb = ref.on('value', snap => {
          setAllNotes(snap.exists()?snap.val():{});
        });
        return () => ref.off('value', cb);
      }, []);

      function handleNoteChange(e) {
        const val = e.target.value;
        setNoteText(val);
        database.ref('notes/'+dateKey).set(val);
      }

      // ÎÇ†ÏßúÎ≥Ñ ÏÉâÏÉÅ Íµ¨ÎèÖ
      React.useEffect(() => {
        const ref = database.ref('dateColors');
        const cb = ref.on('value', snap => {
          setDateColors(snap.exists()?snap.val():{});
        });
        return () => ref.off('value', cb);
      }, []);

      // export image
      async function exportAsImage() {
        await document.fonts.ready;
        const container = document.getElementById('export-container');
        const canvas = await html2canvas(container, { scale: window.devicePixelRatio, useCORS:true, allowTaint:true, backgroundColor:'#fff' });
        canvas.toBlob(async blob => {
          const perm = await navigator.permissions.query({ name:'clipboard-write' });
          if(perm.state==='granted'||perm.state==='prompt') await navigator.clipboard.write([new ClipboardItem({'image/png':blob})]);
          alert('ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏñ¥.');
        });
      }

      // Í∏∞Î≥∏ÌôîÎ©¥ Ïù¥Îèô
      function goToday() { setSelectedDate(new Date()); setView('todo'); }

      // Î†åÎçî
      return (
        <div style={{minHeight:'100vh',display:'flex'}}>
          <button onClick={()=>setShowSidebar(!showSidebar)} style={{position:'fixed',left:'1rem',top:'1rem',zIndex:10,background:'#fff',padding:'0.5rem',borderRadius:'9999px',boxShadow:'0 2px 5px rgba(0,0,0,0.1)',cursor:'pointer'}} className="md:hidden">
            {showSidebar?'‚Üê':'‚Üí'}
          </button>
          <div style={{position:'fixed',left:0,top:0,bottom:0,width:'16rem',background:'#fff',boxShadow:'0 2px 5px rgba(0,0,0,0.1)',zIndex:20,overflow:'visible',transform:showSidebar?'translateX(0)':'translateX(-100%)',transition:'transform 0.3s'}}>
            <div className="sidebar-nav">
              <h2>{selectedDate.getFullYear()}\n{selectedDate.toLocaleString('en-US',{month:'long'})}</h2>
            </div>
            <div style={{padding:'0 1rem'}}>
              <div style={{display:'grid',gridTemplateColumns:'repeat(7,1fr)',gap:'0.25rem',fontSize:'0.875rem',color:'#666'}}>
                {['S','M','T','W','T','F','S'].map(d=><div key={d} style={{textAlign:'center',fontWeight:'500'}}>{d}</div>)}
                {Array(new Date(selectedDate.getFullYear(),selectedDate.getMonth(),1).getDay()).fill().map((_,i)=><div key={i}/>)}
                {Array.from({length: new Date(selectedDate.getFullYear(),selectedDate.getMonth()+1,0).getDate()},(_,i)=>{
                  const d = new Date(selectedDate.getFullYear(),selectedDate.getMonth(),i+1);
                  const key = d.toLocaleDateString('en-CA');
                  const isSel = key===dateKey;
                  const color = dateColors[key]||accentColor;
                  return <button key={i} onClick={()=>{setSelectedDate(d);if(window.innerWidth<768)setShowSidebar(false);}} style={{width:'1.8rem',height:'1.8rem',margin:'0 auto',display:'flex',alignItems:'center',justifyContent:'center',borderRadius:'9999px',background:isSel?color:'transparent',color:isSel?'#fff':'#000',position:'relative',cursor:'pointer'}}><span>{i+1}</span></button>;
                })}
              </div>
              <div className="sidebar-controls">
                <button onClick={()=>setSelectedDate(d=>new Date(d.getFullYear(),d.getMonth()-1,1))}>‚Üê</button>
                <button onClick={goToday}>Today</button>
                <button onClick={()=>setSelectedDate(d=>new Date(d.getFullYear(),d.getMonth()+1,1))}>‚Üí</button>
              </div>
              <div style={{textAlign:'center'}}><button className="sidebar-controls" onClick={()=>setView('notes')}>Notes</button></div>
            </div>
          </div>
          <div style={{flex:1,padding:'1rem',transition:'margin-left 0.3s',marginLeft:showSidebar?'16rem':'0'}}>
            {view==='todo' ? (
              <div id="export-container" className="main-container">
                <h2 style={{fontSize:'1.25rem',fontWeight:'bold',marginBottom:'1rem'}}>{selectedDate.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</n2>
                <textarea className="note-input" value={noteText} onChange={handleNoteChange} placeholder="Ïò§ÎäòÏùò Ìïú ÎßàÎîî..." rows={2}/>
                {/* Í∏∞Ï°¥ Ìï† Ïùº ÏûÖÎ†•Î∂Ä Î∞è Î¶¨Ïä§Ìä∏... (ÏÉùÎûµ ÏóÜÏù¥ Í∏∞Ï°¥ ÏΩîÎìú Ïú†ÏßÄ) */}
                {items.length>0 && <button onClick={exportAsImage} style={{background:accentColor,color:'#fff',border:'none',padding:'0.5rem',borderRadius:'0.25rem',cursor:'pointer'}}>Export as Image</button>}
              </div>
            ) : (
              <div className="main-container">
                <button className="back-btn" onClick={()=>setView('todo')}>Back</button>
                <div className="notes-list">
                  {Object.entries(allNotes).sort((a,b)=>b[0].localeCompare(a[0])).map(([key,note])=>{
                    const d = new Date(key);
                    const color = dateColors[key]||accentColor;
                    return <div key={key} className="note-card">
                      <div className="note-color" style={{background:color}}/>
                      <div><strong>{d.toLocaleDateString('en-US',{year:'numeric',month:'numeric',day:'numeric',weekday:'short'})}</strong></div>
                      <div>{note}</div>
                    </div>;
                  })}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
