<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ùêù : ·¥õ·¥è·¥Ö·¥è</title>
  <link rel="icon" href="./favi.ico" type="image/x-icon" />
  <style>
    @font-face { font-family: 'HJSS'; src: url('./HJSS.ttf') format('truetype'); }
    body { margin: 0; padding: 0; font-family: 'HJSS', sans-serif; background: #f5f5f5; box-sizing: border-box; }
    *, *::before, *::after { box-sizing: inherit; }
    .edit-delete-btn { font-size: 0.75rem; color: #888; background: none; border: none; cursor: pointer; margin-left: 0.5rem; }
    .sidebar-nav h2 { margin: 1rem 0; font-weight: bold; text-align: center; line-height: 1.2; }
    .sidebar-controls { display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 1rem; }
    .sidebar-controls button { background: #f0f0f0; border: none; padding: 0.5rem 0.75rem; border-radius: 0.25rem; cursor: pointer; }
    .main-container { max-width: 42rem; margin: 0 auto; background: #fff; border-radius: 0.5rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 1.5rem; }
    .note-input { width: 100%; border: 1px solid #ccc; padding: 0.5rem; border-radius: 0.25rem; resize: vertical; margin-bottom: 1rem; }
    .notes-list { display: flex; flex-direction: column; gap: 1rem; }
    .note-card { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.25rem; background: #fafafa; }
    .note-color { width: 1rem; height: 1rem; border-radius: 0.25rem; }
    .back-btn { margin-bottom: 1rem; background: #f0f0f0; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React, Babel, Firebase, html2canvas -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script type="text/babel">
    // KST ÌòÑÏû¨ ÎÇ†Ïßú Íµ¨ÌïòÍ∏∞
    const getKSTDate = () => {
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset() * 60000;
      return new Date(utc + 9 * 60 * 60000);
    };

    const firebaseConfig = {
      apiKey: "...",
      authDomain: "...",
      databaseURL: "...",
      projectId: "...",
      storageBucket: "...",
      messagingSenderId: "...",
      appId: "..."
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function App() {
      const [selectedDate, setSelectedDate] = React.useState(getKSTDate());
      const [todos, setTodos] = React.useState([]);
      const [noteText, setNoteText] = React.useState('');
      const [allNotes, setAllNotes] = React.useState({});
      const [dateColors, setDateColors] = React.useState({});
      const [text, setText] = React.useState('');
      const [categoryText, setCategoryText] = React.useState('');
      const [view, setView] = React.useState('todo');
      const [editMode, setEditMode] = React.useState(false);

      const dateKey = selectedDate.toISOString().split('T')[0];
      const weekdays = ['S','M','T','W','T','F','S'];
      const weekdayColors = ['#C87171','#666','#666','#666','#666','#666','#7192C8'];

      // Íµ¨ÎèÖ: todos
      React.useEffect(() => {
        const ref = db.ref(`todos/${dateKey}`);
        const cb = ref.on('value', snap => {
          setTodos(snap.exists() ? snap.val() : []);
        });
        return () => ref.off('value', cb);
      }, [dateKey]);

      // Íµ¨ÎèÖ: Ïò§Îäò ÎÖ∏Ìä∏
      React.useEffect(() => {
        const ref = db.ref(`notes/${dateKey}`);
        const cb = ref.on('value', snap => {
          setNoteText(snap.exists() ? snap.val() : '');
        });
        return () => ref.off('value', cb);
      }, [dateKey]);

      // Íµ¨ÎèÖ: Î™®Îì† ÎÖ∏Ìä∏
      React.useEffect(() => {
        const ref = db.ref('notes');
        const cb = ref.on('value', snap => {
          setAllNotes(snap.exists() ? snap.val() : {});
        });
        return () => ref.off('value', cb);
      }, []);

      // Íµ¨ÎèÖ: ÎÇ†ÏßúÎ≥Ñ Ïª¨Îü¨
      React.useEffect(() => {
        const ref = db.ref('dateColors');
        const cb = ref.on('value', snap => {
          setDateColors(snap.exists() ? snap.val() : {});
        });
        return () => ref.off('value', cb);
      }, []);

      function saveNote(e) {
        const val = e.target.value;
        setNoteText(val);
        db.ref(`notes/${dateKey}`).set(val);
      }

      function saveColor(e) {
        const col = e.target.value;
        db.ref('dateColors').update({ [dateKey]: col });
      }

      async function exportImage() {
        const container = document.getElementById('export-container');
        container.style.background = '#fff';
        await document.fonts.ready;
        const canvas = await html2canvas(container, {
          scale: window.devicePixelRatio,
          backgroundColor: '#fff'
        });
        canvas.toBlob(blob => {
          navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
          alert('ÎèåÏïÑÍ∞ÄÏûê.');
        });
      }

      function goToday() {
        setSelectedDate(getKSTDate());
        setView('todo');
      }

      // Ìï† Ïùº Ï∂îÍ∞Ä Îì±...
      const addTodo = () => {
        if (!text.trim()) return;
        db.ref(`todos/${dateKey}`).once('value').then(snap => {
          const list = snap.exists() ? snap.val() : [];
          list.push({ type: 'todo', text: text.trim(), state: 0 });
          db.ref(`todos/${dateKey}`).set(list);
          setText('');
        });
      };
      const addCategory = () => {
        if (!categoryText.trim()) return;
        db.ref(`todos/${dateKey}`).once('value').then(snap => {
          const list = snap.exists() ? snap.val() : [];
          list.push({ type: 'category', text: categoryText.trim() });
          db.ref(`todos/${dateKey}`).set(list);
          setCategoryText('');
        });
      };
      const addDivider = () =>
        db.ref(`todos/${dateKey}`).once('value').then(snap => {
          const list = snap.exists() ? snap.val() : [];
          list.push({ type: 'divider' });
          db.ref(`todos/${dateKey}`).set(list);
        });
      const toggleState = i =>
        db.ref(`todos/${dateKey}`).once('value').then(snap => {
          const list = snap.exists() ? snap.val() : [];
          if (list[i].type === 'todo') list[i].state = (list[i].state + 1) % 3;
          db.ref(`todos/${dateKey}`).set(list);
        });
      const deleteItem = i =>
        db.ref(`todos/${dateKey}`).once('value').then(snap => {
          const list = snap.exists() ? snap.val() : [];
          list.splice(i, 1);
          db.ref(`todos/${dateKey}`).set(list);
        });
      const editItem = i =>
        db.ref(`todos/${dateKey}`).once('value').then(snap => {
          const list = snap.exists() ? snap.val() : [];
          const v = prompt('Edit:', list[i].text);
          if (v !== null && v.trim()) {
            list[i].text = v.trim();
            db.ref(`todos/${dateKey}`).set(list);
          }
        });

      // Î†åÎçîÎßÅ
      return (
        <div style={{ display: 'flex', minHeight: '100vh' }}>
          <div style={{
            width: '16rem', background: '#fff',
            boxShadow: '0 2px 5px rgba(0,0,0,0.1)'
          }}>
            <div className="sidebar-nav">
              <h2>
                {selectedDate.getFullYear()}<br/>
                {selectedDate.toLocaleString('en-US',{month:'long'})}
              </h2>
            </div>
            <div style={{ padding: '0 1rem' }}>
              <div className="sidebar-controls">
                <button onClick={() => setSelectedDate(d =>
                  new Date(d.getFullYear(), d.getMonth() - 1, 1)
                )}>‚Üê</button>
                <button onClick={goToday}>Today</button>
                <button onClick={() => setSelectedDate(d =>
                  new Date(d.getFullYear(), d.getMonth() + 1, 1)
                )}>‚Üí</button>
              </div>
              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(7,1fr)',
                gap: '0.25rem',
                textAlign: 'center',
                fontSize: '0.875rem',
                color: '#666'
              }}>
                {weekdays.map((d,i) => (
                  <div key={i} style={{ color: weekdayColors[i], fontWeight: '500' }}>
                    {d}
                  </div>
                ))}
                {Array(new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1)
                  .getDay()).fill().map((_,i)=><div key={i}/>)}
                {Array.from(
                  { length:
                    new Date(selectedDate.getFullYear(), selectedDate.getMonth()+1, 0).getDate()
                  },
                  (_,i) => {
                    const dt = new Date(
                      selectedDate.getFullYear(), selectedDate.getMonth(), i+1
                    );
                    const key = dt.toISOString().split('T')[0];
                    const isSel = key === dateKey;
                    const bg = isSel ? (dateColors[key]||'#888') : 'transparent';
                    return (
                      <button key={i}
                        onClick={() => setSelectedDate(dt)}
                        style={{
                          width:'1.8rem', height:'1.8rem',
                          margin:'0 auto', display:'flex',
                          alignItems:'center', justifyContent:'center',
                          border:'none', background: bg,
                          borderRadius:'9999px', cursor:'pointer',
                          color: isSel ? '#fff' : '#000'
                        }}>
                        {i+1}
                      </button>
                    );
                  }
                )}
              </div>
              <div style={{ textAlign:'center', margin: '1rem 0' }}>
                <button onClick={()=>setView('notes')} className="sidebar-controls">Notes</button>
              </div>
            </div>
          </div>

          <div style={{
            flex: 1, padding: '1rem',
            background: '#f5f5f5'
          }}>
            {view === 'todo' ? (
              <div id="export-container" className="main-container">
                <h2 style={{ marginBottom:'1rem' }}>
                  {selectedDate.toLocaleDateString('en-US', {
                    weekday:'long', year:'numeric',
                    month:'long', day:'numeric'
                  })}
                </h2>
                <div style={{ marginBottom:'1rem', display:'flex', alignItems:'center', gap:'0.5rem' }}>
                  <span>This date‚Äôs color:</span>
                  <input type="color"
                    value={dateColors[dateKey]||'#888'}
                    onChange={saveColor}
                  />
                </div>
                <textarea className="note-input"
                  value={noteText}
                  onChange={saveNote}
                  placeholder="Ïò§ÎäòÏùò ÌïúÎßàÎîî‚Ä¶"
                  rows={2}
                />
                <textarea
                  value={text}
                  onChange={e=>setText(e.target.value)}
                  onKeyDown={e=>e.key==='Enter'&&!e.shiftKey&&(e.preventDefault(),addTodo())}
                  placeholder="Add a task‚Ä¶ (Enter to save)"
                  rows={3}
                  style={{
                    width:'100%', border:'1px solid #ccc',
                    padding:'0.5rem', borderRadius:'0.25rem',
                    resize:'vertical', marginBottom:'1rem'
                  }}
                />
                <div style={{
                  display:'grid', gridTemplateColumns:'auto 1fr',
                  gap:'0.5rem', marginBottom:'1rem'
                }}>
                  <button onClick={addDivider}>Add Divider</button>
                  <input type="text"
                    value={categoryText}
                    onChange={e=>setCategoryText(e.target.value)}
                    onKeyDown={e=>e.key==='Enter'&&addCategory()}
                    placeholder="Add category‚Ä¶"
                    style={{ padding:'0.5rem', border:'1px solid #ccc', borderRadius:'0.25rem' }}
                  />
                </div>
                <div style={{ display:'flex', flexDirection:'column', gap:'0.5rem' }}>
                  {todos.map((item,i) => (
                    item.type==='divider' ? (
                      <hr key={i} style={{ borderColor:'#888' }} />
                    ) : item.type==='category' ? (
                      <div key={i} style={{ fontWeight:'600', padding:'0.5rem' }}>
                        {item.text}
                      </div>
                    ) : (
                      <div key={i}
                        onClick={()=>toggleState(i)}
                        style={{
                          display:'flex', alignItems:'center',
                          gap:'0.5rem', padding:'0.5rem',
                          borderRadius:'0.25rem', background:'#fafafa',
                          cursor: editMode ? 'default':'pointer'
                        }}>
                        <span style={{ fontFamily:'monospace', fontSize:'1.25rem' }}>
                          {['‚òê','‚òë','‚òí'][item.state]}
                        </span>
                        <span style={{ flex:1, whiteSpace:'pre-wrap' }}>
                          {item.text}
                        </span>
                        {editMode && <>
                          <button className="edit-delete-btn" onClick={()=>editItem(i)}>Edit</button>
                          <button className="edit-delete-btn" onClick={()=>deleteItem(i)}>Del</button>
                        </>}
                      </div>
                    )
                  ))}
                </div>
                <div style={{ marginTop:'1rem', display:'flex', gap:'0.5rem' }}>
                  <button onClick={exportImage}>Export as Image</button>
                  <button onClick={()=>setEditMode(m=>!m)}>
                    {editMode ? 'Done':'Edit'}
                  </button>
                </div>
              </div>
            ) : (
              <div className="main-container">
                <button className="back-btn" onClick={()=>setView('todo')}>Back</button>
                <div className="notes-list">
                  {Object.entries(allNotes).sort((a,b)=>b[0].localeCompare(a[0])).map(([k,n])=>{
                    const d = new Date(k);
                    return (
                      <div key={k} className="note-card">
                        <div className="note-color"
                             style={{ background: dateColors[k]||'#888' }} />
                        <div>
                          <strong>{d.toLocaleDateString('en-US',{
                            year:'numeric',month:'numeric',day:'numeric',weekday:'short'
                          })}</strong>
                        </div>
                        <div>{n}</div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
